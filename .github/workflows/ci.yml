name: linting
on: [push]
jobs:
  render-charts:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          show-progress: false
      - name: Run govuk-app-render
        run: ./govuk-app-render.sh
      - name: Archive rendered charts
        uses: actions/upload-artifact@v4
        with:
          name: rendered-charts
          path: output/
          retention-days: 1

  ct:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.head_ref }}
          show-progress: false
      - uses: azure/setup-helm@v4
      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2
        with:
          version: v3.12.0
      - name: Run chart-testing (lint)
        run: ct lint --config ct.yml

  helm-lint:
    runs-on: ubuntu-latest
    needs: render-charts
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: rendered-charts
          path: .

      - uses: azure/setup-helm@v4

      - name: helm lint
        run: |
          EXITCODE=0
          for env in values/*; do
            for chart in ${env}/*; do
              chart_name=$(basename "${chart}")
              for app in ${chart}/*; do
                echo "helm lint for app ${app} with chart ${chart_name}"
                helm lint --quiet -f "${app}" "raw-charts/${chart_name}";
                if [ $? -ne 0 ]; then
                  echo "$output";
                  EXITCODE=1
                fi
              done
            done
          done
          exit "${EXITCODE}"

  kubeconform:
    runs-on: ubuntu-latest
    needs: render-charts
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: rendered-charts
          path: .
      - name: kubeconform
        uses: docker://ghcr.io/yannh/kubeconform:latest-alpine
        with:
          entrypoint: /kubeconform
          args: >
            -kubernetes-version 1.31.6
            -schema-location default
            -schema-location
            "https://alphagov.github.io/govuk-crd-library/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json"
            -ignore-filename-pattern ".*/Chart.yaml"
            -summary
            rendered-charts

  shellcheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          show-progress: false
      - uses: ludeeus/action-shellcheck@00cae500b08a931fb5698e11e79bfbd38e612a38  # 2.0.0
        env:
          SHELLCHECK_OPTS: -xP SCRIPTDIR

  yamllint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          show-progress: false
      - run: yamllint --version && yamllint -f github .

  promtool:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          show-progress: false
      - name: Run promtool checks
        uses: ./.github/actions/promtool
        with:
          args: >
            check rules $(find charts/monitoring-config/rules -name '*.yaml' \
              -not -name '*_tests.yaml')
      - name: Run promtool tests
        uses: ./.github/actions/promtool
        with:
          args: test rules charts/monitoring-config/rules/*_tests.yaml

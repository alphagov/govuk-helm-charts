{{- if .Values.uploadAssets.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-upload-assets
  annotations:
    argocd.argoproj.io/hook: PreSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  backoffLimit: 2  # Retry once, in case of network error.
  template:
    spec:
      containers:
      - name: {{ .Release.Name }}-upload-assets
        image: "{{ .Values.appImage.repository }}:{{ required "Valid .Values.appImage.tag required!" .Values.appImage.tag }}"
        env:
        - name: ASSETS_SOURCE_PATH
          value: {{ .Values.uploadAssets.path | default (printf "/app/public/assets/%s" .Release.Name) }}
        - name: ASSETS_DEST_DIR
          value: {{ .Values.uploadAssets.s3Directory | default .Release.Name }}
        - name: GOVUK_ENVIRONMENT
          value: {{ .Values.govukEnvironment }}
        command:
        - "sh"
        - "-c"
        - |-
          {{- .Files.Get "upload-assets.sh" | nindent 10 }}
      restartPolicy: Never
{{- end }}

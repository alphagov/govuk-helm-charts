{{- if .Values.uploadAssets.enabled -}}
{{- $destDir := .Values.uploadAssets.s3Directory | default .Release.Name }}
{{- $sourcePath := .Values.uploadAssets.path | default (printf "/app/public/assets/%s" .Release.Name) }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-upload-assets
  annotations:
    argocd.argoproj.io/hook: PreSync
spec:
  template:
    spec:
      initContainers:
      - name: {{ .Release.Name }}-copy-assets-for-upload
        image: "{{ .Values.appImage.repository }}:{{ required "Valid .Values.appImage.tag required!" .Values.appImage.tag }}"
        command:
        - sh
        - -c
        - "cp -R {{ $sourcePath }}/* /assets-to-upload"
        volumeMounts: &volumeMounts
        - name: assets-to-upload
          mountPath: /assets-to-upload
      containers:
      - name: {{ .Release.Name }}-upload-assets
        image: public.ecr.aws/bitnami/aws-cli
        command:
        - aws
        - s3
        - sync
        - /assets-to-upload
        - "{{- printf "s3://govuk-app-assets-%s/assets/%s/" .Values.govukEnvironment $destDir }}"
        volumeMounts: *volumeMounts
      restartPolicy: Never
      volumes:
      - name: assets-to-upload
        emptyDir: {}
{{- end }}

{{- /*
To debug this template, run `helm template . --name-template=static`.
*/}}
{{- if eq .Release.Name "static" }}
apiVersion: batch/v1
kind: Job
metadata:
  name: upload-static-error-pages
  annotations:
    argocd.argoproj.io/hook: PostSync
    argocd.argoproj.io/hook-delete-policy: HookSucceeded
spec:
  backoffLimit: 2
  template:
    spec:
      securityContext:
        runAsNonRoot: {{ .Values.securityContext.runAsNonRoot }}
      containers:
        - name: upload-static-error-pages
          # TODO: find a way to keep this up-to-date
          image: amazon/aws-cli:2.4.25
          env:
            - name: GOVUK_ENVIRONMENT
              value: {{ .Values.govukEnvironment }}
          command:
            - "/bin/sh"
            - "-c"
            - |-
              {{- .Files.Get "upload-static-error-pages.sh" | nindent 14 }}
          {{- with .Values.jobResources }}
          resources:
            {{- . | toYaml | trim | nindent 12 }}
          {{- end }}
      restartPolicy: Never
{{- end }}

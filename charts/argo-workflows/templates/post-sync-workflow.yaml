apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: post-sync
spec:
  entrypoint: handle-sync-event
  onExit: exit-handler
  arguments:
    parameters:
      # NOTE: template parameters are overridden by the calling Sensor
      - name: application
        value:
  templates:
    - name: handle-sync-event
      dag:
        tasks:
          - name: smoke-test
            templateRef:
              name: smoke-test
              template: smoke-test
            arguments:
              parameters:
                - name: application
                  value: "{{
                    "{{workflow.parameters.application}}"
                  }}"
    - name: exit-handler
      steps:
      - - name: notify
          template: send-slack
    - name: send-slack
      container:
        image: curlimages/curl
        command:
          - "curl"
          - "-X"
          - "POST"
          - "--data-urlencode"
          - >
              payload={
                "channel": "#govuk-deploy-alerts",
                "username": "argocd",
                "text": "smokey test for {{"{{workflow.parameters.application}}"}} has status {{"{{workflow.status}}"}} :deployparrot:",
                "icon_emoji": ":kubernetes:"
              }
          - "$(SLACK_WEBHOOK_ENDPOINT)"
        env:
          - name: SLACK_WEBHOOK_ENDPOINT
            valueFrom:
              secretKeyRef:
                name: slack-webhook-url
                key: url

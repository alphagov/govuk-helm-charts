apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: post-sync
spec:
  entrypoint: handle-sync-event
  onExit: exit-handler
  retryStrategy:
    limit: "3"
    expression: "asInt(lastRetry.exitCode) > 1"
  arguments:
    parameters:
      - name: application
      - name: commitSha
      - name: argoUrl
      - name: slackChannel
      - name: repoName
      - name: imageTag
  templates:
    - name: handle-sync-event
      dag:
        tasks:
          - name: smoke-test
            templateRef:
              name: smoke-test
              template: smoke-test
            arguments:
              parameters:
                - name: extra-args
                  value: "{{" and @app-{{workflow.parameters.application}}"}}"
          - name: promote-release
            depends: smoke-test.Succeeded
            templateRef:
              name: update-image-tag
              template: update-image-tag
            arguments:
              parameters:
                - name: environment
                  value: "{{ .Values.nextEnvironment }}"
                - name: repoName
                  value: "{{"{{workflow.parameters.repoName}}"}}"
                - name: imageTag
                  value: "{{"{{workflow.parameters.imageTag}}"}}"

    - name: exit-handler
      steps:
        - - name: notify-slack
            templateRef:
              name: notify-slack
              template: notify-slack
            arguments:
              parameters:
                - name: slackChannel
                  # NOTE: Change to {{"{{workflow.parameters.slackChannel}}"}} to
                  # send to team slack channel.
                  value: "govuk-deploy-alerts"
                - name: text
                  value: "\
                    post-sync job ({{"{{workflow.name}}"}}) for <{{"{{workflow.parameters.argoUrl}}"}}|{{"{{workflow.parameters.application}}"}}> in {{ .Values.govukEnvironment }} {{"{{workflow.status}}"}} \
                    (revision <https://github.com/alphagov/govuk-helm-charts/commits/{{"{{workflow.parameters.commitSha}}"}}|{{"{{workflow.parameters.commitSha}}"}}>)."

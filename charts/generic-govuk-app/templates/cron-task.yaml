{{- $fullName := include "generic-govuk-app.fullname" . }}
{{- range .Values.cronTasks }}
{{- $cronName := print $fullName "-" .name "-cron-task" }}
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: "{{ $cronName }}"
  labels:
    {{- include "generic-govuk-app.labels" $ | nindent 4 }}
    app: "{{ $fullName }}-{{ .name }}-cron-task"
    app.kubernetes.io/name: "{{ $fullName }}-{{ .name }}-cron-task"
    app.kubernetes.io/component: "{{ .name }}-cron-task"
spec:
  schedule: "{{ .schedule }}"
  jobTemplate:
    metadata:
      name: "{{ $cronName }}"
      labels:
        {{- include "generic-govuk-app.labels" $ | nindent 8 }}
        app.kubernetes.io/component: "{{ .name }}-cron-task"
    spec:
      backoffLimit: 0
      template:
        metadata:
          name: "{{ $cronName }}"
          labels:
            {{- include "generic-govuk-app.labels" $ | nindent 12 }}
            app.kubernetes.io/component: "{{ .name }}-cron-task"
        spec:
          automountServiceAccountToken: {{- if .serviceAccount }} true {{- else }} false {{- end }}
          enableServiceLinks: false
          securityContext:
            fsGroup: {{ $.Values.securityContext.runAsGroup }}
            runAsNonRoot: {{ $.Values.securityContext.runAsNonRoot }}
            runAsUser: {{ $.Values.securityContext.runAsUser }}
            runAsGroup: {{ $.Values.securityContext.runAsGroup }}
          restartPolicy: Never
          {{ if .serviceAccount }}serviceAccountName: {{ .serviceAccount }}{{- end }}
          volumes:
            - name: app-tmp
              emptyDir: {}
            {{- with $.Values.extraVolumes }}
              {{- . | toYaml | trim | nindent 12 }}
            {{- end }}
          containers:
            - name: cron-task
              image: "{{ $.Values.appImage.repository }}:{{ $.Values.appImage.tag }}"
              imagePullPolicy: {{ $.Values.appImage.pullPolicy | default "Always" }}
              {{- if .task }}
              command: ["rails"]
              args: ["{{ .task }}"]
              {{- else if .command }}
              command: ["/bin/bash"]
              args: ["-c", "{{ .command }}"]
              {{- end }}
              envFrom:
                - configMapRef:
                    name: govuk-apps-env
              env:
                - name: SENTRY_RELEASE
                  value: "{{ $.Values.appImage.tag }}"
                {{- with $.Values.extraEnv }}
                  {{- . | toYaml | trim | nindent 16 }}
                {{- end }}
              {{- with $.Values.appResources }}
              resources:
                {{- . | toYaml | trim | nindent 16 }}
              {{- end }}
              securityContext:
                allowPrivilegeEscalation: false
                readOnlyRootFilesystem: true
              volumeMounts:
                - name: app-tmp
                  mountPath: /tmp
                {{- with $.Values.appExtraVolumeMounts }}
                  {{- . | toYaml | trim | nindent 16 }}
                {{- end }}
{{- if .monitoring.enabled }}
{{- $match := print $cronName "-.*" }}
{{- $runTimeMax := .monitoring.runTime.maximumSeconds | default 600 | toString }}
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: {{ $cronName }}
spec:
  groups:
    - name: {{ $cronName }}
      interval: 1m
      rules:
        - alert: {{ $cronName }}-failed
          expr: 'kube_job_failed{job_name=~"{{ $match }}",condition="true"}'
          for: 1m
          labels:
            severity: {{ .monitoring.failureSeverity | default "warning" }}
            description: "Run for cron job '{{ $.Release.Namespace }}/{{ $cronName }}' has failed"
        - alert: {{ $cronName }}-long-run-time
          expr: '(kube_job_status_completion_time{job_name=~"{{ $match }}"} - kube_job_status_start_time{job_name=~"{{ $match }}-.*"}) > {{ $runTimeMax }}'
          for: 1m
          labels:
            severity: {{ .monitoring.runTime.severity | default "warning" }}
            description: "Run for cron job '{{ $.Release.Namespace }}/{{ $cronName }}' has taken too long (over {{ $runTimeMax }} seconds)"
{{- end }}
{{- end }}

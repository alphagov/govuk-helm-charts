{{- if or .Values.uploadStaticErrorPagesEnabled (eq .Release.Name "static") }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ .Release.Name }}-upload-error-pages
  annotations:
    argocd.argoproj.io/hook: PostSync
    kubernetes.io/description: >
      Fetch "static" error pages from the Static service and upload them to S3.
      ArgoCD runs this job after each deployment of the Static app.
spec:
  template:
    spec:
      securityContext:
        runAsNonRoot: true
        runAsUser: 1001
        runAsGroup: 1001
      containers:
        - name: upload-static-error-pages
          image: public.ecr.aws/bitnami/aws-cli:2
          securityContext:
            allowPrivilegeEscalation: false
          env:
            - name: GOVUK_ENVIRONMENT
              value: {{ .Values.govukEnvironment }}
            - name: SERVICE
              value: {{ .Release.Name }}
          command:
            - "/bin/bash"
            - "-c"
            - |
              {{- .Files.Get "upload-static-error-pages.sh" | nindent 14 }}
          {{- with .Values.jobResources }}
          resources:
            {{- . | toYaml | trim | nindent 12 }}
          {{- end }}
      restartPolicy: Never
{{- end }}

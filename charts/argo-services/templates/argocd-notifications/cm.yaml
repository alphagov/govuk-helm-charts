apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
data:
  context: |
    argocdUrl: "{{ .Values.argocdUrl }}"
  service.webhook.slack_webhook: |
    "headers":
    - "name": "Content-Type"
      "value": "application/json"
    "url": "$slack_url"
  template.send-slack: |
    "webhook":
      "slack_webhook":
        "body": |
          {
            "attachments": [{
              "title": "{{"{{.app.metadata.name}}"}}",
              "title_link": "{{"{{.context.argocdUrl}}"}}/applications/{{"{{.app.metadata.name}}"}}",
              {{"{{- if eq .app.status.operationState.phase \"Succeeded\" -}}"}}
              "color": "#18be52",
              {{"{{- else if eq .app.status.operationState.phase \"Running\" -}}"}}
              "color": "#beb618",
              {{"{{- else if or (eq .app.status.operationState.phase \"Error\") (eq .app.status.operationState.phase \"Failed\") -}}"}}
              "color": "#be1b18",
              {{"{{- else -}}"}}
              "color": "#183cbe",
              {{"{{- end -}}"}}
              "fields": [{
                "title": "state",
                "value": "{{"{{.app.status.operationState.phase}}"}}",
                "short": true
              }]
            }]
          }
        "method": "POST"
  trigger.sync-operation-change: |
    - "oncePer": "app.status.operationState.syncResult.revision"
      "send":
      - "send-slack"
      "when": "app.status.operationState.phase in ['Succeeded'] and app.status.health.status
        == 'Healthy'"
    - "oncePer": "app.status.operationState.syncResult.revision"
      "send":
      - "send-slack"
      "when": "app.status.operationState.phase in ['Running']"
    - "oncePer": "app.status.operationState.syncResult.revision"
      "send":
      - "send-slack"
      "when": "app.status.operationState.phase in ['Error', 'Failed']"

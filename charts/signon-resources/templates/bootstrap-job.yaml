apiVersion: batch/v1
kind: Job
metadata:
  name: "bootstrap-signon-resources-{{ randNumeric 8 }}"
spec:
  template:
    metadata:
      name: bootstrap-signon-resources
    spec:
      restartPolicy: Never
      serviceAccountName: signon-secrets-bootstrapper
      containers:
      - name: bootstrap-signon-resources
        image: "{{ .Values.common.image.repository }}:{{ .Values.common.image.tag }}"
        command: ["bundle"]
        args: ["exec", "rake", "bootstrap:signon"]
        env:
          - name: SIGNON_AUTH_TOKEN
            valueFrom:
              secretKeyRef:
                name: signon-auth-token
                key: token
          - name: APPLICATIONS
            value: |-
              {
                "content-store": {
                  "name": "Content Store",
                  "slug": "content-store",
                  "secret_name": "signon-app-content-store",
                  "description": "Central store for current live content on GOV.UK",
                  "home_uri": "https://content-store.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://content-store.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "draft-content-store": {
                  "name": "Draft Content Store",
                  "slug": "draft-content-store",
                  "secret_name": "signon-app-draft-content-store",
                  "description": "Central store for draft content on GOV.UK",
                  "home_uri": "https://draft-content-store.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://draft-content-store.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "router-api": {
                  "name": "Router API",
                  "slug": "router-api",
                  "secret_name": "signon-app-router-api",
                  "description": "Manages the Router database",
                  "home_uri": "https://router-api.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://router-api.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "asset-manager": {
                  "name": "Asset Manager",
                  "slug": "asset-manager",
                  "secret_name": "signon-app-asset-manager",
                  "description": "Manages assets",
                  "home_uri": "https://asset-manager.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://asset-manager.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "link-checker-api": {
                  "name": "Link Checker API",
                  "slug": "link-checker-api",
                  "secret_name": "signon-app-link-checker-api",
                  "description": "Checks links",
                  "home_uri": "https://link-checker-api.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://link-checker-api.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "publisher-eks": {
                  "name": "Publisher [EKS]",
                  "slug": "publisher-eks",
                  "secret_name": "signon-app-publisher-eks",
                  "description": "Mainstream publishing application",
                  "home_uri": "https://publisher.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://publisher.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["view_all"]
                },
                "publishing-api": {
                  "name": "Publishing API",
                  "slug": "publishing-api",
                  "secret_name": "signon-app-publishing-api",
                  "description": "Central store for all publishing content on GOV.UK",
                  "home_uri": "https://publishing-api.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://publishing-api.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["view_all"]
                },
                "whitehall": {
                  "name": "Whitehall",
                  "slug": "whitehall",
                  "secret_name": "signon-app-whitehall-eks",
                  "description": "Mainstream Whitehall application",
                  "home_uri": "https://whitehall-admin.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://whitehall-admin.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                }
              }
          - name: API_USERS
            value: |-
              {
                "content-store": {
                  "name": "Content Store",
                  "username": "content-store",
                  "email": "content-store@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "router-api" }
                  ]
                },
                "frontend": {
                  "name": "Frontend",
                  "username": "frontend",
                  "email": "frontend@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" }
                  ]
                },
                "publisher": {
                  "name": "Publisher",
                  "username": "publisher",
                  "email": "publisher@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" },
                    { "application_slug": "link-checker-api" },
                    { "application_slug": "asset-manager" }
                  ]
                },
                "publishing-api": {
                  "name": "Publishing API",
                  "username": "publishing-api",
                  "email": "publishing-api@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "content-store" },
                    { "application_slug": "draft-content-store" },
                    { "application_slug": "router-api" }
                  ]
                },
                "whitehall": {
                  "name": "Whitehall",
                  "username": "whitehall",
                  "email": "whitehall@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" },
                    { "application_slug": "link-checker-api" },
                    { "application_slug": "asset-manager" }
                  ]
                }
              }
          - name: SIGNON_API_ENDPOINT
            value: http://signon.apps.{{.Values.clusterDomain}}/api/v1
          - name: GOVUK_PUBLISHING_DOMAIN
            value: {{.Values.govukEnvironment}}.{{.Values.govukPublishingDomain}}

# This job creates objects in GOV.UK Signon which are needed for end-user and
# app-to-app authentication/authorisation. It creates:
#
# - Signon Doorkeeper::Application objects
# - Signon ApiUser objects
# - Signon Application authorisations (essentially OAuth bearer tokens).
# - Kubernetes secrets to store the OAuth secret keys and bearer tokens
#   associated with the above objects.
#
# The APPLICATIONS environment variable:
#
# - defines Signon Application objects which will be created if they don't
#   exist (based on the name field).
#
# - declares Signon Application objects which already exist (based on the name
#   field), so that they can be referred to in the API_USERS environment
#   variable. The description and permissions fields are updated if they differ
#   from what is in Signon. Other fields such as `home_uri` and `redirect_uri`
#   are not updated (but this may change in future; check the [source code]).
#
# The API_USERS environment variable:
#
# - defines Signon ApiUser objects which will be created if they don't exist
#   (based on the `email` field).
#
# - authorises the ApiUser to use the set of apps listed in its `bearer_tokens`
#   field and grants the corresponding permissions (if any).
#
# - ignores any changes to an authorisation if the corresponding Kubernetes
#   secret already exists (based on the name, which follows the pattern
#   `signon-token-${username}-${application_slug}`.
#
# The keys of the JSON objects in the APPLICATIONS and API_USERS environment
# variables, referred to as slugs, are internal to the bootstrap script and are
# not used within Signon itself. Their purpose is:
#
# - to allow API users to refer to Applications in order to define which
#   Applications an API user should have access to, and therefore which bearer
#   tokens and secrets should be created.
#
# - to help construct human-readable names for the Kubernetes secrets which the
#   script creates.
#
# [source code]: https://github.com/alphagov/govuk-infrastructure/search?q=Signon%3A%3AClient%3A%3AApplicationAlreadyCreated+-path%3Aspec
apiVersion: batch/v1
kind: Job
metadata:
  name: "bootstrap-signon-resources-{{ randNumeric 8 }}"
spec:
  template:
    metadata:
      name: bootstrap-signon-resources
    spec:
      restartPolicy: Never
      serviceAccountName: signon-secrets-bootstrapper
      containers:
      - name: bootstrap-signon-resources
        image: "{{ .Values.appImage.repository }}:{{ .Values.appImage.tag }}"
        command: ["bundle"]
        args: ["exec", "rake", "bootstrap:signon"]
        env:
          - name: SIGNON_AUTH_TOKEN
            valueFrom:
              secretKeyRef:
                name: signon-auth-token
                key: token
          - name: APPLICATIONS
            value: |-
              {
                "account-api-ec2": {
                  "name": "Account API",
                  "secret_name": "signon-app-account-api-ec2",
                  "description": "API to manage GOV.UK Accounts feature",
                  "home_uri": "https://account-api.{{ .Values.publishingServiceDomainSuffix }}",
                  "redirect_uri": "https://account-api.{{ .Values.publishingServiceDomainSuffix }}/auth/gds/callback",
                  "permissions": ["internal_app", "update_protected_attributes"]
                },
                "content-store": {
                  "name": "Content Store [EKS]",
                  "secret_name": "signon-app-content-store",
                  "description": "Central store for current live content on GOV.UK",
                  "home_uri": "https://content-store.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://content-store.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "draft-content-store": {
                  "name": "Draft Content Store [EKS]",
                  "secret_name": "signon-app-draft-content-store",
                  "description": "Central store for draft content on GOV.UK",
                  "home_uri": "https://draft-content-store.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://draft-content-store.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "email-alert-api-ec2": {
                  "name": "Email Alert API",
                  "secret_name": "signon-app-email-alert-api-ec2",
                  "description": "API to manage GOV.UK email subscriptions",
                  "home_uri": "https://email-alert-api.{{ .Values.publishingServiceDomainSuffix }}",
                  "redirect_uri": "https://email-alert-api.{{ .Values.publishingServiceDomainSuffix }}/auth/gds/callback",
                  "permissions": ["internal_app", "status_updates"]
                },
                "router-api-ec2": {
                  "name": "Router API",
                  "secret_name": "signon-app-router-api-ec2",
                  "description": "Manages the Router database",
                  "home_uri": "https://router-api.{{ .Values.publishingServiceDomainSuffix }}",
                  "redirect_uri": "https://router-api.{{ .Values.publishingServiceDomainSuffix }}/auth/gds/callback",
                  "permissions": []
                },
                "asset-manager-ec2": {
                  "name": "Asset Manager",
                  "secret_name": "signon-app-asset-manager-ec2",
                  "description": "Manages assets",
                  "home_uri": "https://asset-manager.{{ .Values.publishingServiceDomainSuffix }}",
                  "redirect_uri": "https://asset-manager.{{ .Values.publishingServiceDomainSuffix }}/auth/gds/callback",
                  "permissions": []
                },
                "asset-manager": {
                  "name": "Asset Manager [EKS]",
                  "secret_name": "signon-app-asset-manager",
                  "description": "Manages assets",
                  "home_uri": "https://asset-manager.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://asset-manager.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "authenticating-proxy": {
                  "name": "Content Preview (aka Authenticating Proxy) [EKS]",
                  "secret_name": "signon-app-authenticating-proxy",
                  "description": "Provides authenticated access to draft content on GOV.UK",
                  "home_uri": "https://draft-origin.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://draft-origin.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "link-checker-api-ec2": {
                  "name": "Link Checker API",
                  "secret_name": "signon-app-link-checker-api-ec2",
                  "description": "Checks links on GOV.UK",
                  "home_uri": "https://link-checker-api.{{ .Values.publishingServiceDomainSuffix }}",
                  "redirect_uri": "https://link-checker-api.{{ .Values.publishingServiceDomainSuffix }}/auth/gds/callback",
                  "permissions": []
                },
                "publisher": {
                  "name": "Publisher [EKS]",
                  "secret_name": "signon-app-publisher",
                  "description": "Mainstream publishing application",
                  "home_uri": "https://publisher.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://publisher.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["govuk_editor", "skip_review", "welsh_editor"]
                },
                "publishing-api-ec2": {
                  "name": "Publishing API",
                  "secret_name": "signon-app-publishing-api-ec2",
                  "description": "Central store for all publishing content on GOV.UK",
                  "home_uri": "https://publishing-api.{{ .Values.publishingServiceDomainSuffix }}",
                  "redirect_uri": "https://publishing-api.{{ .Values.publishingServiceDomainSuffix }}/auth/gds/callback",
                  "permissions": ["view_all"]
                },
                "publishing-api": {
                  "name": "Publishing API [EKS]",
                  "secret_name": "signon-app-publishing-api",
                  "description": "Central store for all publishing content on GOV.UK",
                  "home_uri": "https://publishing-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://publishing-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["view_all"]
                },
                "whitehall": {
                  "name": "Whitehall [EKS]",
                  "secret_name": "signon-app-whitehall",
                  "description": "Create and manage non-mainstream content on GOV.UK",
                  "home_uri": "https://whitehall-admin.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://whitehall-admin.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": [
                    "Coronavirus Travel Editor",
                    "Editor",
                    "Export data",
                    "GDS Admin",
                    "GDS Editor",
                    "Import CSVs",
                    "Managing Editor",
                    "Preview Design System",
                    "Upload Executable File Attachments",
                    "VIP Editor",
                    "World Editor",
                    "World Writer"
                  ]
                },
                "search-api-ec2": {
                  "name": "Search API",
                  "secret_name": "signon-app-search-api-ec2",
                  "description": "Search API for GOV.UK",
                  "home_uri": "https://search-api.{{ .Values.publishingServiceDomainSuffix }}",
                  "redirect_uri": "https://search-api.{{ .Values.publishingServiceDomainSuffix }}/auth/gds/callback",
                  "permissions": ["ltr_training", "manage_search_indices"]
                },
                "search-api": {
                  "name": "Search API [EKS]",
                  "secret_name": "signon-app-search-api",
                  "description": "Search API for GOV.UK",
                  "home_uri": "https://search-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://search-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["ltr_training", "manage_search_indices"]
                },
                "support-ec2": {
                  "name": "Support",
                  "secret_name": "signon-app-support-ec2",
                  "description": "Raise support requests",
                  "home_uri": "https://support.{{ .Values.publishingServiceDomainSuffix }}",
                  "redirect_uri": "https://support.{{ .Values.publishingServiceDomainSuffix }}/auth/gds/callback",
                  "permissions": [
                    "api_users",
                    "campaign_requesters",
                    "content_requesters",
                    "feedex",
                    "feedex_exporters",
                    "feedex_reviews",
                    "single_points_of_contact",
                    "user_managers"
                  ]
                },
                "support-api-ec2": {
                  "name": "Support API",
                  "secret_name": "signon-app-support-api-ec2",
                  "description": "Stores and retrieves anonymous feedback about pages on GOV.UK.",
                  "home_uri": "https://support-api.{{ .Values.publishingServiceDomainSuffix }}",
                  "redirect_uri": "https://support-api.{{ .Values.publishingServiceDomainSuffix }}/auth/gds/callback",
                  "permissions": []
                },
                "hmrc-manuals-api": {
                  "name": "HMRC Manuals API [EKS]",
                  "secret_name": "signon-app-hmrc-manuals-api",
                  "description": "API for allowing HMRC to publish redacted manuals to GOV.UK",
                  "home_uri": "https://hmrc-manuals-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://hmrc-manuals-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "router-api": {
                  "name": "Router API [EKS]",
                  "secret_name": "signon-app-router-api",
                  "description": "Manages the Router database",
                  "home_uri": "https://router-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://router-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                }
              }
          - name: API_USERS
            value: |-
              {
                "collections": {
                  "name": "Collections",
                  "username": "collections",
                  "email": "collections@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "email-alert-api-ec2", "permissions": ["internal_app"] }
                  ]
                },
                "content-store": {
                  "name": "Content Store",
                  "username": "content-store",
                  "email": "content-store@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "router-api-ec2" },
                    { "application_slug": "publishing-api-ec2" }
                  ]
                },
                "feedback": {
                  "name": "Feedback",
                  "username": "feedback",
                  "email": "feedback@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api-ec2" },
                    { "application_slug": "support-api-ec2" },
                    { "application_slug": "support-ec2", "permissions": ["api_users"] }
                  ]
                },
                "frontend": {
                  "name": "Frontend",
                  "username": "frontend",
                  "email": "frontend@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api-ec2" },
                    { "application_slug": "email-alert-api-ec2", "permissions": ["internal_app"] },
                    { "application_slug": "account-api-ec2", "permissions": ["internal_app"] }
                  ]
                },
                "publisher": {
                  "name": "Publisher",
                  "username": "publisher",
                  "email": "publisher@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api-ec2" },
                    { "application_slug": "link-checker-api-ec2" },
                    { "application_slug": "asset-manager-ec2" }
                  ]
                },
                "publishing-api": {
                  "name": "Publishing API",
                  "username": "publishing-api",
                  "email": "publishing-api@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "content-store" },
                    { "application_slug": "draft-content-store" },
                    { "application_slug": "router-api" }
                  ]
                },
                "smokey": {
                  "name": "Smokey",
                  "username": "smokey",
                  "email": "smokey@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "asset-manager" }
                  ]
                },
                "whitehall": {
                  "name": "Whitehall",
                  "username": "whitehall",
                  "email": "whitehall@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "asset-manager-ec2" },
                    { "application_slug": "email-alert-api-ec2", "permissions": ["internal_app"] },
                    { "application_slug": "link-checker-api-ec2" },
                    { "application_slug": "publishing-api-ec2" },
                    { "application_slug": "search-api-ec2", "permissions": ["manage_search_indices"] }
                  ]
                },
                "manuals-frontend": {
                  "name": "Manuals Frontend",
                  "username": "manuals-frontend",
                  "email": "manuals-frontend@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api-ec2" }
                  ]
                },
                "email-alert-frontend": {
                  "name": "Email Alert Frontend",
                  "username": "email-alert-frontend",
                  "email": "email-alert-frontend@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "account-api-ec2", "permissions": ["internal_app"] },
                    { "application_slug": "email-alert-api-ec2", "permissions": ["internal_app"] },
                    { "application_slug": "publishing-api-ec2" }
                  ]
                },
                "smartanswers": {
                  "name": "Smart Answers",
                  "username": "smartanwsers",
                  "email": "smartanswers@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "link-checker-api-ec2" },
                    { "application_slug": "publishing-api-ec2" }
                  ]
                },
                "finder-frontend": {
                  "name": "Finder Frontend",
                  "username": "finder-frontend",
                  "email": "finder-frontend@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "account-api-ec2", "permissions": ["internal_app"] },
                    { "application_slug": "email-alert-api-ec2", "permissions": ["internal_app"] }
                  ]
                },
                "search-api": {
                  "name": "Search API",
                  "username": "search-api",
                  "email": "search-api@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" }
                  ]
                },
                "hmrc-manuals-api": {
                  "name": "HMRC Manuals API",
                  "username": "hmrc-manuals-api",
                  "email": "hmrc-manuals-api@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" }
                  ]
                },
                "licence-finder": {
                  "name": "Licence Finder",
                  "username": "licence-finder",
                  "email": "licence-finder@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api-ec2" }
                  ]
                }
              }
          - name: SIGNON_API_ENDPOINT
            value: http://signon/api/v1
          - name: GOVUK_PUBLISHING_DOMAIN
            value: {{ .Values.publishingServiceDomainSuffix }}

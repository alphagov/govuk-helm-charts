apiVersion: batch/v1
kind: Job
metadata:
  name: "bootstrap-signon-resources-{{ randNumeric 8 }}"
spec:
  template:
    metadata:
      name: bootstrap-signon-resources
    spec:
      restartPolicy: Never
      serviceAccountName: signon-secrets-bootstrapper
      containers:
      - name: bootstrap-signon-resources
        image: "{{ .Values.appImage.repository }}:{{ .Values.appImage.tag }}"
        command: ["bundle"]
        args: ["exec", "rake", "bootstrap:signon"]
        env:
          - name: SIGNON_AUTH_TOKEN
            valueFrom:
              secretKeyRef:
                name: signon-auth-token
                key: token
          - name: APPLICATIONS
            value: |-
              {
                "account-api": {
                  "name": "Account API [EKS]",
                  "secret_name": "signon-app-account-api",
                  "description": "API to manage GOV.UK Accounts feature",
                  "home_uri": "https://account-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://account-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["internal_app","update_protected_attributes","internal_app"]
                },
                "content-store": {
                  "name": "Content Store [EKS]",
                  "secret_name": "signon-app-content-store",
                  "description": "Central store for current live content on GOV.UK",
                  "home_uri": "https://content-store.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://content-store.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "draft-content-store": {
                  "name": "Draft Content Store [EKS]",
                  "secret_name": "signon-app-draft-content-store",
                  "description": "Central store for draft content on GOV.UK",
                  "home_uri": "https://draft-content-store.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://draft-content-store.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "email-alert-api": {
                  "name": "Email Alert API",
                  "secret_name": "signon-app-email-alert-api",
                  "description": "API to manage GOV.UK email subscriptions",
                  "home_uri": "https://email-alert-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://email-alert-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["internal_app","status_updates"]
                },
                "router-api": {
                  "name": "Router API",
                  "secret_name": "signon-app-router-api",
                  "description": "Manages the Router database",
                  "home_uri": "https://router-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://router-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "asset-manager": {
                  "name": "Asset Manager [EKS]",
                  "secret_name": "signon-app-asset-manager",
                  "description": "Manages assets",
                  "home_uri": "https://asset-manager.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://asset-manager.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "authenticating-proxy": {
                  "name": "Content Preview (aka Authenticating Proxy) [EKS]",
                  "secret_name": "signon-app-authenticating-proxy",
                  "description": "Provides authenticated access to draft content on GOV.UK",
                  "home_uri": "https://draft-origin.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://draft-origin.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "link-checker-api": {
                  "name": "Link Checker API [EKS]",
                  "secret_name": "signon-app-link-checker-api",
                  "description": "Checks links",
                  "home_uri": "https://link-checker-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://link-checker-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": []
                },
                "publisher-eks": {
                  "name": "Publisher [EKS]",
                  "secret_name": "signon-app-publisher-eks",
                  "description": "Mainstream publishing application",
                  "home_uri": "https://publisher.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://publisher.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["skip_review","govuk_editor","welsh_editor"]
                },
                "publishing-api": {
                  "name": "Publishing API",
                  "secret_name": "signon-app-publishing-api",
                  "description": "Central store for all publishing content on GOV.UK",
                  "home_uri": "https://publishing-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://publishing-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["view_all"]
                },
                "whitehall-eks": {
                  "name": "Whitehall [EKS]",
                  "secret_name": "signon-app-whitehall-eks",
                  "description": "Mainstream Whitehall application",
                  "home_uri": "https://whitehall-admin.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://whitehall-admin.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["Coronavirus Travel Editor","Editor","Export data","GDS Admin","GDS Editor","Import CSVs","Managing Editor","Upload Executable File Attachments","VIP Editor","World Editor","World Writer"]
                },
                "search-api-eks": {
                  "name": "Search API [EKS]",
                  "secret_name": "signon-app-search-api-eks",
                  "description": "Search API of GOV.UK",
                  "home_uri": "https://search-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://search-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["signin", "ltr_training", "manage_search_indices"]
                },
                "hmrc-manuals-api-eks": {
                  "name": "HMRC Manuals API [EKS]",
                  "secret_name": "signon-app-hmrc-manuals-api",
                  "description": "API for allowing HMRC to publish redacted manuals to GOV.UK",
                  "home_uri": "https://hmrc-manuals-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "redirect_uri": "https://hmrc-manuals-api.eks.{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}/auth/gds/callback",
                  "permissions": ["signin"]
                }
              }
          - name: API_USERS
            value: |-
              {
                "collections": {
                  "name": "Collections",
                  "username": "collections",
                  "email": "collections@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "email-alert-api", "permissions": ["internal_app"] }
                  ]
                },
                "content-store": {
                  "name": "Content Store",
                  "username": "content-store",
                  "email": "content-store@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "router-api" },
                    { "application_slug": "publishing-api" }
                  ]
                },
                "frontend": {
                  "name": "Frontend",
                  "username": "frontend",
                  "email": "frontend@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" },
                    { "application_slug": "email-alert-api", "permissions": ["internal_app"] },
                    { "application_slug": "account-api", "permissions": ["internal_app"] }
                  ]
                },
                "publisher": {
                  "name": "Publisher",
                  "username": "publisher",
                  "email": "publisher@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" },
                    { "application_slug": "link-checker-api" },
                    { "application_slug": "asset-manager" }
                  ]
                },
                "publishing-api": {
                  "name": "Publishing API",
                  "username": "publishing-api",
                  "email": "publishing-api@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "content-store" },
                    { "application_slug": "draft-content-store" },
                    { "application_slug": "router-api" }
                  ]
                },
                "whitehall": {
                  "name": "Whitehall",
                  "username": "whitehall",
                  "email": "whitehall@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "asset-manager" },
                    { "application_slug": "email-alert-api", "permissions": ["internal_app"] },
                    { "application_slug": "link-checker-api" },
                    { "application_slug": "publishing-api" },
                    { "application_slug": "search-api-eks", "permissions": ["manage_search_indices"] }
                  ]
                },
                "manuals-frontend": {
                  "name": "Manuals Frontend",
                  "username": "manuals-frontend",
                  "email": "manuals-frontend@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" }
                  ]
                },
                "email-alert-frontend": {
                  "name": "Email Alert Frontend",
                  "username": "email-alert-frontend",
                  "email": "email-alert-frontend@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "account-api", "permissions": ["internal_app"] },
                    { "application_slug": "email-alert-api", "permissions": ["internal_app"] },
                    { "application_slug": "publishing-api" }
                  ]
                },
                "smartanswers": {
                  "name": "Smart Answers",
                  "username": "smartanwsers",
                  "email": "smartanswers@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "link-checker-api" },
                    { "application_slug": "publishing-api" }
                  ]
                },
                "finder-frontend": {
                  "name": "Finder Frontend",
                  "username": "finder-frontend",
                  "email": "finder-frontend@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "account-api", "permissions": ["internal_app"] },
                    { "application_slug": "email-alert-api", "permissions": ["internal_app"] }
                  ]
                },
                "search-api-eks": {
                  "name": "Search API",
                  "username": "search-api",
                  "email": "search-api@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" }
                  ]
                },
                "hmrc-manuals-api-eks": {
                  "name": "HMRC Manuals API",
                  "username": "hmrc-manuals-api",
                  "email": "hmrc-manuals-api@{{ .Values.govukEnvironment }}.{{ .Values.govukDomainExternal }}",
                  "bearer_tokens": [
                    { "application_slug": "publishing-api" }
                  ]
                }
              }
          - name: SIGNON_API_ENDPOINT
            value: http://signon.apps.{{.Values.clusterDomain}}/api/v1
          - name: GOVUK_PUBLISHING_DOMAIN
            value: {{.Values.govukEnvironment}}.{{.Values.govukPublishingDomain}}

# Defaults for all apps in this environment. These can be overridden for
# individual apps below.

govukEnvironment: integration
externalDomainSuffix: integration.publishing.service.gov.uk
k8sExternalDomainSuffix: eks.integration.govuk.digital
publishingDomainSuffix: integration.publishing.service.gov.uk
assetsDomain: assets.integration.publishing.service.gov.uk

cspReportURI: https://csp-reporter.integration.publishing.service.gov.uk/report

workerReplicaCount: 1
appResources:
  limits:
    cpu: 1
    memory: 1500Mi
  requests:
    cpu: 0.1
    memory: 800Mi

default-alb-ingress-annotations: &default-alb-ingress-annotations
  alb.ingress.kubernetes.io/scheme: internet-facing
  alb.ingress.kubernetes.io/target-type: ip
  alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}, {"HTTPS": 443}]'
  alb.ingress.kubernetes.io/ssl-redirect: "443"
  alb.ingress.kubernetes.io/healthcheck-path: /readyz
  alb.ingress.kubernetes.io/load-balancer-name: "{{ .Release.Name }}"
  alb.ingress.kubernetes.io/load-balancer-attributes: >
    access_logs.s3.enabled=true,
    access_logs.s3.bucket=govuk-{{ .Values.govukEnvironment }}-aws-logging,
    access_logs.s3.prefix=elb/{{ .Release.Name }}

alb-ingress-www-waf-ruleset: &alb-ingress-www-waf-ruleset
  alb.ingress.kubernetes.io/wafv2-acl-arn: >-
    arn:aws:wafv2:eu-west-1:210287912431:regional/webacl/cache_public_web_acl/768d0100-1296-4047-ad74-e307c4836a10

alb-ingress-backend-waf-ruleset: &alb-ingress-backend-waf-ruleset
  alb.ingress.kubernetes.io/wafv2-acl-arn: >-
    arn:aws:wafv2:eu-west-1:210287912431:regional/webacl/backend_public_web_acl/b5f616fd-699e-4b44-8ea2-7afd6626aa98


# Individual apps to be deployed by ArgoCD, and any values specific to those
# apps.

govukApplications:
- name: account-api
  helmValues:
    uploadAssets:
      enabled: false
    dbMigrationEnabled: true
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-www-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "account-api.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: account-api.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: account-api-postgres
            key: DATABASE_URL
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-account-api-email-alert-api
            key: bearer_token
      - name: GOVUK_ACCOUNT_OAUTH_CLIENT_ID
        valueFrom:
          secretKeyRef:
            name: govuk-account-oauth
            key: GOVUK_ACCOUNT_OAUTH_CLIENT_ID
      - name: GOVUK_ACCOUNT_OAUTH_PRIVATE_KEY
        valueFrom:
          secretKeyRef:
            name: govuk-account-oauth
            key: GOVUK_ACCOUNT_OAUTH_PRIVATE_KEY
      - name: GOVUK_ACCOUNT_OAUTH_PROVIDER_URI
        valueFrom:
          secretKeyRef:
            name: govuk-account-oauth
            key: GOVUK_ACCOUNT_OAUTH_PROVIDER_URI
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: account-api-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: 6074fdc2-03b3-4bb6-83fe-31220779c13b
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-account-api-publishing-api
            key: bearer_token
      - name: SESSION_SECRET
        valueFrom:
          secretKeyRef:
            name: account-api-session-secret
            key: session_secret
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-account-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-account-api
            key: oauth_secret
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: asset-manager
  chartPath: charts/asset-manager
  helmValues:
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-www-waf-ruleset
        alb.ingress.kubernetes.io/load-balancer-name: assets-origin
        alb.ingress.kubernetes.io/group.name: assets-origin
        alb.ingress.kubernetes.io/group.order: '20'
        alb.ingress.kubernetes.io/load-balancer-attributes: &assets-lb-attributes >
          access_logs.s3.enabled=true,
          access_logs.s3.bucket=govuk-{{ .Values.govukEnvironment }}-aws-logging,
          access_logs.s3.prefix=elb/assets-origin
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: &assets-lb-conditions >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "*assets*.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: assets-origin.{{ .Values.k8sExternalDomainSuffix }}
          paths:
            - path: /assets/  # Integration only
            - path: /government/uploads/
            - path: /government/assets/
            - path: /media/
            - path: /auth/gds  # Viewing draft assets requires user auth.
            - path: /whitehall_assets/  # Integration only
        - name: draft-assets.{{ .Values.k8sExternalDomainSuffix }}
          paths:
            - path: /assets/  # Integration only
            - path: /government/uploads/
            - path: /government/assets/
            - path: /media/
            - path: /auth/gds  # Viewing draft assets requires user auth.
            - path: /whitehall_assets/  # Integration only
    assetManagerNFS: &assets-nfs assets.blue.integration.govuk-internal.digital
    nginxConfigMap:
      create: false
      name: asset-manager-nginx-conf
    extraEnv:
      - name: ASSET_MANAGER_CLAMSCAN_PATH
        value: /usr/bin/clamdscan
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-asset-manager
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-asset-manager
            key: oauth_secret
      - name: JWT_AUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: authenticating-proxy-jwt-auth-secret
            key: JWT_AUTH_SECRET
      - name: MONGODB_URI
        valueFrom:
          secretKeyRef:
            name: asset-manager-docdb
            key: MONGODB_URI
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: AWS_REGION
        value: eu-west-1
      - name: AWS_S3_BUCKET_NAME
        value: govuk-assets-integration

- name: argo-services
  chartPath: charts/argo-services
  postSyncWorkflowEnabled: "false"
  helmValues:
    nextEnvironment: staging

- name: authenticating-proxy
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/load-balancer-name: draft-origin
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "draft-origin.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: draft-origin.{{ .Values.k8sExternalDomainSuffix }}
    uploadAssets:
      enabled: false
    extraEnv:
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: authenticating-proxy-postgres
            key: DATABASE_URL
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-content-preview
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-content-preview
            key: oauth_secret
      - name: GOVUK_UPSTREAM_URI
        value: "http://draft-router"
      - name: JWT_AUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: authenticating-proxy-jwt-auth-secret
            key: JWT_AUTH_SECRET

- name: bouncer
  helmValues:
    rails:
      enabled: false
    uploadAssets:
      enabled: false
    ingress:
      enabled: true
      tls: {}
      annotations:
        <<: *alb-ingress-www-waf-ruleset
        alb.ingress.kubernetes.io/scheme: internet-facing
        alb.ingress.kubernetes.io/target-type: ip
        alb.ingress.kubernetes.io/listen-ports: '[{"HTTP": 80}]'
        alb.ingress.kubernetes.io/healthcheck-path: /readyz
        alb.ingress.kubernetes.io/security-groups: eks_ingress_www_origin
        external-dns.alpha.kubernetes.io/hostname: bouncer.{{ .Values.k8sExternalDomainSuffix }}
      rules:
        - http:  # Match all hostnames.
            paths:
              - path: "/"
                pathType: Prefix
                backend:
                  service:
                    name: bouncer
                    port:
                      number: 80
    extraEnv:
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: bouncer-postgres
            key: DATABASE_URL
    nginxConfigMap:
      extraServerConf: |
        # TODO: Find out which council is using this and ask them update.
        location /eff/action/worldPayCallback {
          proxy_pass https://www.gov.uk/apply-for-a-licence/payment/worldpayCallback;
        }

- name: cache-clearing-service
  helmValues:
    uploadAssets:
      enabled: false
    dbMigrationEnabled: false
    rails:
      enabled: false
    appEnabled: false
    podDisruptionBudget: {}
    workerEnabled: true
    workers:
      - command: ["rake", "message_queue:consumer", "QUEUE=high"]
        name: high
      - command: ["rake", "message_queue:consumer", "QUEUE=medium"]
        name: medium
      - command: ["rake", "message_queue:consumer", "QUEUE=low"]
        name: low
    extraEnv:
      - name: RABBITMQ_URL
        valueFrom:
          secretKeyRef:
            name: cache-clearing-service-rabbitmq
            key: RABBITMQ_URL

- name: collections
  helmValues:
    extraEnv:
      - name: MEMCACHE_SERVERS
        value: frontend-memcached-govuk.eks.integration.govuk-internal.digital
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-collections-email-alert-api
            key: bearer_token

- name: draft-collections
  repoName: collections
  helmValues:
    rails:
      createKeyBaseSecret: false
    sentry:
      createSecret: false
    uploadAssets:
      enabled: false
    extraEnv:
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-collections-email-alert-api
            key: bearer_token
      - name: PLEK_HOSTNAME_PREFIX
        value: draft-

- name: collections-publisher
  helmValues:
    dbMigrationEnabled: true
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "collections-publisher.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: collections-publisher.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-collections-publisher
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-collections-publisher
            key: oauth_secret
      - name: LINK_CHECKER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-collections-publisher-link-checker-api
            key: bearer_token
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-collections-publisher-publishing-api
            key: bearer_token
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-collections-publisher-email-alert-api
            key: bearer_token
      - name: JWT_AUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: authenticating-proxy-jwt-auth-secret
            key: JWT_AUTH_SECRET
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: collections-publisher-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: &publishing-notify-template 759acac6-da53-4a19-b591-b7538c7c39de
      - name: PUBLISH_WITHOUT_2I_EMAIL
        value: mainstream-publisher-notifications-integration@digital.cabinet-office.gov.uk
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: collections-publisher-mysql
            key: DATABASE_URL
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: contacts-admin
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "contacts-admin.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: contacts-admin.{{ .Values.k8sExternalDomainSuffix }}
    cronTasks:
      - name: org-import
        task: "organisations:import"
        schedule: "0 3 * * *"
    extraEnv:
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: contacts-admin-mysql
            key: DATABASE_URL
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-contacts
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-contacts
            key: oauth_secret
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-contacts-publishing-api
            key: bearer_token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: content-data-admin
  helmValues:
    ingress:
      enabled: true
      redirect: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "content-data.{{ .Values.publishingDomainSuffix }}"
          ]}}]
        alb.ingress.kubernetes.io/actions.{{ .Release.Name }}-redirect: >
          {
            "Type":"redirect",
            "RedirectConfig": {
              "Host":"content-data.{{ .Values.publishingDomainSuffix }}",
              "Path":"/#{path}",
              "Port":"443",
              "Protocol":"HTTPS",
              "Query":"#{query}",
              "StatusCode":"HTTP_301"
            }
          }
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}-redirect: >
          [{"field":"host-header","hostHeaderConfig":{"values":[
              "content-data-admin.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: content-data.{{ .Values.k8sExternalDomainSuffix }}
    nginxProxyReadTimeout: 60s
    workerEnabled: true
    extraEnv:
      - name: CONTENT_DATA_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-content-data-admin-content-data-api
            key: bearer_token
      # These GA/GTM values are not secrets (not even the the gtm_auth one).
      # https://github.com/alphagov/govuk-puppet/pull/8041
      - name: GOOGLE_TAG_MANAGER_AUTH
        value: wFyiBTovFhDv5qMe_LXt7Q
      - name: GOOGLE_TAG_MANAGER_ID
        value: GTM-NZG8SF2
      - name: GOOGLE_TAG_MANAGER_PREVIEW
        value: env-7
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-content-data
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-content-data
            key: oauth_secret
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: content-data-admin-aws
            key: access_key
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: content-data-admin-aws
            key: secret_key
      - name: AWS_REGION
        value: eu-west-1
      - name: AWS_CSV_EXPORT_BUCKET_NAME
        value: govuk-integration-content-data-csvs
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: content-data-admin-postgres
            key: DATABASE_URL
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: content-data-admin-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: content-data-api
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "content-data-api.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: content-data-api.{{ .Values.k8sExternalDomainSuffix }}
    nginxProxyReadTimeout: 60s
    uploadAssets:
      enabled: false
    dbMigrationEnabled: true
    workerEnabled: true
    workers:
      - command: ["sidekiq", "-C", "config/sidekiq.yml"]
        name: worker
      - command: ['rake', 'publishing_api:consumer']
        name: publishing-api-consumer
      - command: ['rake', 'publishing_api:bulk_import_consumer']
        name: bulk-import-publishing-api-consumer
    cronTasks:
      - name: etl
        task: "etl:main"
        schedule: "22 13 * * *"
    extraEnv:
      - name: GOOGLE_ANALYTICS_GOVUK_VIEW_ID
        valueFrom:
          secretKeyRef:
            name: content-data-api-google-analytics
            key: view-id
      - name: GOOGLE_CLIENT_EMAIL
        valueFrom:
          secretKeyRef:
            name: content-data-api-google-analytics
            key: client-email
      - name: GOOGLE_PRIVATE_KEY
        valueFrom:
          secretKeyRef:
            name: content-data-api-google-analytics
            key: private-key
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-content-data-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-content-data-api
            key: oauth_secret
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-content-data-api-publishing-api
            key: bearer_token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: content-data-api-postgres
            key: DATABASE_URL
      - name: SUPPORT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-content-data-api-support-api
            key: bearer_token
      - name: RABBITMQ_URL
        valueFrom:
          secretKeyRef:
            name: content-data-api-rabbitmq
            key: RABBITMQ_URL
      - name: RABBITMQ_QUEUE
        value: content_data_api
      - name: RABBITMQ_QUEUE_BULK
        value: content_data_api_govuk_importer
      - name: RABBITMQ_QUEUE_DEAD
        value: content_data_api_dead_letter_queue

- name: content-publisher
  helmValues:
    dbMigrationEnabled: true
    nginxClientMaxBodySize: &max-upload-size 500M
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "content-publisher.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: content-publisher.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: AWS_REGION  # TODO: consider moving this to cm/govuk-apps-env?
        value: eu-west-1
      - name: ASSET_MANAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-content-publisher-asset-manager
            key: bearer_token
      - name: AWS_S3_BUCKET
        value: govuk-integration-content-publisher-activestorage
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: content-publisher-postgres
            key: DATABASE_URL
      - name: EMAIL_ADDRESS_OVERRIDE
        value: content-publisher-notifications-integration@digital.cabinet-office.gov.uk
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-content-publisher
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-content-publisher
            key: oauth_secret
      # These GTM values are not secrets (not even the the gtm_auth one).
      # https://github.com/alphagov/govuk-puppet/pull/8041
      - name: GOOGLE_TAG_MANAGER_ID
        value: &static-gtm-id GTM-NQXC4TG
      - name: GOOGLE_TAG_MANAGER_AUTH  # Non-prod only.
        value: &static-gtm-auth xTPyDeRcMiXFWvscgkLowg
      - name: GOOGLE_TAG_MANAGER_PREVIEW  # Non-prod only.
        value: &static-gtm-preview env-6
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: content-publisher-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: JWT_AUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: authenticating-proxy-jwt-auth-secret
            key: JWT_AUTH_SECRET
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-content-publisher-publishing-api
            key: bearer_token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: WHITEHALL_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-content-publisher-whitehall
            key: bearer_token

- name: content-store
  helmValues: &content-store
    nginxClientMaxBodySize: 20M
    cronTasks:
      - name: report-delays
        task: "publishing_delay_report:report_delays"
        schedule: "15 2 * * *"
    uploadAssets:
      enabled: false
    extraEnv:
      - name: ROUTER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-content-store-router-api
            key: bearer_token
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-content-store
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-content-store
            key: oauth_secret
      - name: DEFAULT_TTL
        value: "300"
      - name: MONGODB_URI  # Hostnames need to match those shown in MongoDB rs.status().
        value: "mongodb://\
          mongo-1.integration.govuk-internal.digital,\
          mongo-2.integration.govuk-internal.digital,\
          mongo-3.integration.govuk-internal.digital/content_store_production"

- name: draft-content-store
  repoName: content-store
  helmValues:
    <<: *content-store
    rails:
      createKeyBaseSecret: false
    sentry:
      createSecret: false  # Sentry DSNs are per repo.
    extraEnv:
      - name: ROUTER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-draft-content-store-draft-router-api
            key: bearer_token
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-draft-content-store
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-draft-content-store
            key: oauth_secret
      - name: DEFAULT_TTL
        value: "1"
      - name: MONGODB_URI  # Hostnames need to match those shown in MongoDB rs.status().
        value: "mongodb://\
          mongo-1.integration.govuk-internal.digital,\
          mongo-2.integration.govuk-internal.digital,\
          mongo-3.integration.govuk-internal.digital/draft_content_store_production"
      - name: PLEK_HOSTNAME_PREFIX
        value: draft-

- name: draft-content-store-postgresql-branch
  repoName: content-store-postgresql-branch
  helmValues:
    <<: *content-store
    rails:
      createKeyBaseSecret: false
      # use the same secret as the mongo draft-content-store, it will make the
      # eventual switchover easier and reduce toil
      secretKeyBaseName: content-store-rails-secret-key-base
    sentry:
      createSecret: false  # Sentry DSNs are per repo.
    extraEnv:
      - name: ROUTER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-draft-content-store-draft-router-api
            key: bearer_token
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-draft-content-store
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-draft-content-store
            key: oauth_secret
      - name: DEFAULT_TTL
        value: "1"
      - name: PLEK_HOSTNAME_PREFIX
        value: draft-
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: content-store-postgres
            key: DATABASE_URL
      - name: DISABLE_ROUTER_API
        value: "true"

- name: content-tagger
  helmValues:
    dbMigrationEnabled: true
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "content-tagger.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: content-tagger.{{ .Values.k8sExternalDomainSuffix }}
    cronTasks:
      - name: taxonomy-health-checks
        task: "taxonomy:health_checks"
        schedule: "49 * * * *"
      - name: taxonomy-metrics
        task: "metrics:taxonomy:record_all"
        schedule: "14 * * * *"
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-content-tagger
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-content-tagger
            key: oauth_secret
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-content-tagger-publishing-api
            key: bearer_token
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-content-tagger-email-alert-api
            key: bearer_token
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: content-tagger-postgres
            key: DATABASE_URL
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: email-alert-api
  helmValues:
    dbMigrationEnabled: true
    uploadAssets:
      enabled: false
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "email-alert-api-public.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      rules:
        - host: email-alert-api.eks.integration.govuk.digital
          http:
            paths:
              - path: /status-updates
                pathType: Prefix
                backend:
                  service:
                    name: email-alert-api
                    port:
                      number: 80
              - path: /spam-reports
                pathType: Prefix
                backend:
                  service:
                    name: email-alert-api
                    port:
                      number: 80
    extraEnv:
      - name: ACCOUNT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-email-alert-api-account-api
            key: bearer_token
      - name: BULK_MIGRATE_CONFIRMATION_EMAIL_ACCOUNT
        value: email-alert-api-integration@digital.cabinet-office.gov.uk
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: email-alert-api-postgres
            key: DATABASE_URL
      - name: EMAIL_ALERT_AUTH_TOKEN
        valueFrom:
          secretKeyRef:
            name: email-alert-auth
            key: token
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-email-alert-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-email-alert-api
            key: oauth_secret
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: email-alert-api-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: &frontend-notify-template 1fc69d3a-09a2-40f9-852b-03f6fcef5340
      - name: GOVUK_NOTIFY_RECIPIENTS
        value: email-alert-api-integration@digital.cabinet-office.gov.uk
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: WEB_CONCURRENCY
        value: '10'
    nginxConfigMap:
      extraHttpConf: |
        limit_req_zone $binary_remote_addr zone=email_alert_api_public:1M rate=50r/s;
        limit_req_status 429;
      extraServerConf: |
        location ~ ^/(status-updates|spam-reports)(/|$) {
          limit_req zone=email_alert_api_public burst=20 nodelay;
          proxy_pass http://email-alert-api;
        }

- name: email-alert-frontend
  helmValues:
    extraEnv:
      - name: SUBSCRIPTION_MANAGEMENT_ENABLED
        value: "yes"
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: ACCOUNT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-email-alert-frontend-account-api
            key: bearer_token
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-email-alert-frontend-email-alert-api
            key: bearer_token
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-email-alert-frontend-publishing-api
            key: bearer_token
      - name: EMAIL_ALERT_AUTH_TOKEN
        valueFrom:
          secretKeyRef:
            name: email-alert-auth
            key: token

- name: email-alert-service
  helmValues:
    appEnabled: false
    podDisruptionBudget: {}
    rails:
      enabled: false
    uploadAssets:
      enabled: false
    workerEnabled: true
    workers:
      - command: ['bin/email-alert-service']
        name: email-alert-service
    extraEnv:
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-email-alert-service-email-alert-api
            key: bearer_token
      - name: GOVUK_PROMETHEUS_EXPORTER
        value: force
      - name: RABBITMQ_URL
        valueFrom:
          secretKeyRef:
            name: email-alert-service-rabbitmq
            key: RABBITMQ_URL
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: external-secrets
  chartPath: charts/external-secrets
  postSyncWorkflowEnabled: "false"

- name: feedback
  helmValues:
    extraEnv:
      - name: GOVUK_NOTIFY_ACCESSIBLE_FORMAT_REQUEST_REPLY_TO_ID
        value: 93109fea-34d9-4c38-ac7e-1ebc75e7416b
      - name: GOVUK_NOTIFY_ACCESSIBLE_FORMAT_REQUEST_TEMPLATE_ID
        value: 47cef7ea-0849-48aa-9676-0ee0f7baa4ae
      - name: GOVUK_NOTIFY_SURVEY_SIGNUP_REPLY_TO_ID
        value: fee22233-2f28-4b0b-8b6c-4410979f2275
      - name: GOVUK_NOTIFY_SURVEY_SIGNUP_TEMPLATE_ID
        value: eb9ba220-7d74-4aab-975a-bdbe718f69a3
      - name: SUPPORT_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-feedback-support
            key: bearer_token
      - name: SUPPORT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-feedback-support-api
            key: bearer_token
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-feedback-publishing-api
            key: bearer_token
      - name: ASSISTED_DIGITAL_GOOGLE_SPREADSHEET_KEY
        valueFrom:
          secretKeyRef:
            name: feedback-assisted-digital-google-sheet
            key: sheet_id
      - name: GOOGLE_CLIENT_EMAIL
        valueFrom:
          secretKeyRef:
            name: feedback-assisted-digital-google-sheet
            key: client_email
      - name: GOOGLE_PRIVATE_KEY
        valueFrom:
          secretKeyRef:
            name: feedback-assisted-digital-google-sheet
            key: private_key
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: feedback-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: MEMCACHE_SERVERS
        value: frontend-memcached-govuk.eks.integration.govuk-internal.digital

- name: finder-frontend
  helmValues:
    cronTasks:
      - name: registries-refresh
        task: "registries:cache_refresh"
        schedule: "15 * * * *"
    extraEnv:
      - name: MEMCACHE_SERVERS
        value: frontend-memcached-govuk.eks.integration.govuk-internal.digital
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-finder-frontend-email-alert-api
            key: bearer_token
      - name: DISABLE_LTR_ON_PATHS
        value: /find-licences

- name: frontend
  helmValues:
    extraEnv:
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *frontend-notify-template
      - name: MEMCACHE_SERVERS
        value: frontend-memcached-govuk.eks.integration.govuk-internal.digital
      - name: ACCOUNT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-frontend-account-api
            key: bearer_token
      - name: ASSET_MANAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-frontend-asset-manager
            key: bearer_token
      - name: ELECTIONS_API_KEY
        valueFrom:
          secretKeyRef:
            name: frontend-elections-api
            key: key
      - name: ELECTIONS_API_URL
        valueFrom:
          secretKeyRef:
            name: frontend-elections-api
            key: url
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-frontend-email-alert-api
            key: bearer_token
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-frontend-publishing-api
            key: bearer_token

- name: draft-frontend
  repoName: frontend
  helmValues:
    rails:
      createKeyBaseSecret: false
    sentry:
      createSecret: false
    uploadAssets:
      enabled: false
    extraEnv:
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *frontend-notify-template
      - name: PLEK_HOSTNAME_PREFIX
        value: draft-
      - name: ACCOUNT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-frontend-account-api
            key: bearer_token
      - name: ELECTIONS_API_KEY
        valueFrom:
          secretKeyRef:
            name: frontend-elections-api
            key: key
      - name: ELECTIONS_API_URL
        valueFrom:
          secretKeyRef:
            name: frontend-elections-api
            key: url
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-frontend-email-alert-api
            key: bearer_token
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-frontend-publishing-api
            key: bearer_token

- name: government-frontend
  helmValues:
    extraEnv:
      - name: MEMCACHE_SERVERS
        value: frontend-memcached-govuk.eks.integration.govuk-internal.digital

- name: draft-government-frontend
  repoName: government-frontend
  helmValues:
    rails:
      createKeyBaseSecret: false
    sentry:
      createSecret: false  # Sentry DSNs are per repo.
    uploadAssets:
      enabled: false
    extraEnv:
      - name: PLEK_HOSTNAME_PREFIX
        value: draft-

- name: govuk-jobs
  chartPath: charts/govuk-jobs
  postSyncWorkflowEnabled: "false"
  imageValues:
    - "govuk-dependency-checker"
    - "search-api"
    - "search-api-learn-to-rank"
  helmValues:
    learnToRank:
      elasticsearchUri: &elasticsearch-uri https://vpc-blue-elasticsearch6-domain-uolbxqjhkiqmg5w3gg7gio5sty.eu-west-1.es.amazonaws.com
      trainingInstance:
        type: ml.c5.xlarge
        count: '1'
      deployInstance:
        type: ml.t2.medium
        count: '2'
      sageMakerImage: 210287912431.dkr.ecr.eu-west-1.amazonaws.com/search
      sagemakerIamRole: arn:aws:iam::210287912431:role/learn-to-rank-sagemaker
      serviceAccountIamRole: arn:aws:iam::210287912431:role/search-api-learn-to-rank-govuk

- name: hmrc-manuals-api
  helmValues:
    nginxClientMaxBodySize: 2M
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "hmrc-manuals-api.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: hmrc-manuals-api.{{ .Values.k8sExternalDomainSuffix }}
    nginxProxyReadTimeout: 300s
    uploadAssets:
      enabled: false
    extraEnv:
      - name: ALLOW_UNKNOWN_HMRC_MANUAL_SLUGS
        value: "1"
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-hmrc-manuals-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-hmrc-manuals-api
            key: oauth_secret
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-hmrc-manuals-api-publishing-api
            key: bearer_token
      - name: PUBLISH_TOPICS
        value: "1"
      - name: PUMA_TIMEOUT
        value: "300"

- name: imminence
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "imminence.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: imminence.{{ .Values.k8sExternalDomainSuffix }}
    nginxClientMaxBodySize: *max-upload-size
    nginxProxyReadTimeout: 60s
    dbMigrationEnabled: true
    workerEnabled: true
    extraEnv:
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: imminence-postgres
            key: DATABASE_URL
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-imminence
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-imminence
            key: oauth_secret
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: info-frontend

- name: licencefinder
  repoName: licence-finder
  helmValues:
    uploadAssets:
      # https://github.com/alphagov/licence-finder/blob/e60ad6b/config/application.rb#L35
      path: /app/public/assets/licencefinder
      s3Directory: "licencefinder"
    extraEnv:
      # TODO: Use a custom DNS name for ElasticSearch/OpenSearch. See
      # https://aws.amazon.com/about-aws/whats-new/2020/11/amazon-elasticsearch-service-now-supports-defining-a-custom-name-for-your-domain-endpoint/
      - name: ELASTICSEARCH_URI
        value: *elasticsearch-uri
      - name: MONGODB_URI  # Hostnames need to match those shown in MongoDB rs.status().
        value: "mongodb://\
          mongo-1.integration.govuk-internal.digital,\
          mongo-2.integration.govuk-internal.digital,\
          mongo-3.integration.govuk-internal.digital/licence_finder_production"
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-licence-finder-publishing-api
            key: bearer_token

- name: link-checker-api
  helmValues:
    dbMigrationEnabled: true
    uploadAssets:
      enabled: false
    workerEnabled: true
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-link-checker-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-link-checker-api
            key: oauth_secret
      - name: GOOGLE_API_KEY
        valueFrom:
          secretKeyRef:
            name: link-checker-api-google-api-key
            key: GOOGLE_API_KEY
      - name: GOVUK_BASIC_AUTH_CREDENTIALS
        valueFrom:
          secretKeyRef:
            name: basic-auth
            key: password
      - name: GOVUK_USER
        valueFrom:
          secretKeyRef:
            name: basic-auth
            key: username
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: link-checker-api-postgres
            key: DATABASE_URL
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: local-links-manager
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "local-links-manager.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: local-links-manager.{{ .Values.k8sExternalDomainSuffix }}
    cronTasks:
      - name: import-interact
        task: "import:service_interactions:import_all"
        schedule: "0 1 * * *"
      - name: check-links
        task: "check-links"
        schedule: "0 2 * * *"
      - name: export-links
        task: "export:links:s3"
        schedule: "0 3 * * *"
      - name: import-ga
        task: "import:google_analytics"
        schedule: "0 5 * * *"
      - name: export-ga-bad-links
        task: "export:google_analytics:bad_links"
        schedule: "0 6 * * *"
    dbMigrationEnabled: true
    extraEnv:
      - name: GOOGLE_ANALYTICS_GOVUK_VIEW_ID
        valueFrom:
          secretKeyRef:
            name: local-links-manager-google
            key: govuk-view-id
      - name: GOOGLE_CLIENT_EMAIL
        valueFrom:
          secretKeyRef:
            name: local-links-manager-google
            key: client-email
      - name: GOOGLE_EXPORT_ACCOUNT_ID
        valueFrom:
          secretKeyRef:
            name: local-links-manager-google
            key: export-account-id
      - name: GOOGLE_EXPORT_CUSTOM_DATA_IMPORT_SOURCE_ID
        valueFrom:
          secretKeyRef:
            name: local-links-manager-google
            key: export-custom-data-import-source-id
      - name: GOOGLE_EXPORT_TRACKER_ID
        valueFrom:
          secretKeyRef:
            name: local-links-manager-google
            key: export-tracker-id
      - name: GOOGLE_PRIVATE_KEY
        valueFrom:
          secretKeyRef:
            name: local-links-manager-google
            key: private-key
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-local-links-manager
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-local-links-manager
            key: oauth_secret
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-local-links-manager-publishing-api
            key: bearer_token
      - name: LINK_CHECKER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-local-links-manager-link-checker-api
            key: bearer_token
      - name: LINK_CHECKER_API_SECRET_TOKEN
        valueFrom:
          secretKeyRef:
            name: local-links-manager-link-checker-api-callback-token
            key: LINK_CHECKER_API_SECRET_TOKEN
      - name: MEMCACHE_SERVERS
        value: frontend-memcached-govuk.eks.integration.govuk-internal.digital
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: RUN_LINK_GA_EXPORT
        value: "false"
      - name: AWS_S3_ASSET_BUCKET_NAME
        value: "govuk-app-assets-integration"
      - name: AWS_REGION
        value: "eu-west-1"
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: local-links-manager-postgres
            key: DATABASE_URL
    nginxConfigMap:
      extraServerConf: |
        location /data {
          proxy_set_header   Authorization "";
          proxy_set_header   Connection "";
          proxy_set_header   X-Real-IP $remote_addr;  # TODO: pass the actual end-client address
          proxy_hide_header  x-amz-id-2;
          proxy_hide_header  x-amz-meta-server-side-encryption;
          proxy_hide_header  x-amz-request-id;
          proxy_hide_header  x-amz-server-side-encryption;
          proxy_hide_header  x-amz-version-id;
          add_header         Cache-Control "public, max-age=3600";
          proxy_intercept_errors on;
          proxy_pass         https://govuk-app-assets-integration.s3.eu-west-1.amazonaws.com/data/local-links-manager;
        }

- name: locations-api
  helmValues:
    uploadAssets:
      enabled: false
    dbMigrationEnabled: true
    workerEnabled: true
    extraEnv:
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: locations-api-postgres
            key: DATABASE_URL
      - name: OS_PLACES_API_KEY
        valueFrom:
          secretKeyRef:
            name: locations-api-os-places
            key: api-key
      - name: OS_PLACES_API_SECRET
        valueFrom:
          secretKeyRef:
            name: locations-api-os-places
            key: api-secret
      - name: OS_PLACES_API_POSTCODES_PER_SECOND
        value: "1"
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: manuals-publisher
  helmValues:
    nginxClientMaxBodySize: *max-upload-size
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "manuals-publisher.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: manuals-publisher.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: ASSET_MANAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-manuals-publisher-asset-manager
            key: bearer_token
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-manuals-publisher-email-alert-api
            key: bearer_token
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-manuals-publisher
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-manuals-publisher
            key: oauth_secret
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-manuals-publisher-publishing-api
            key: bearer_token
      - name: LINK_CHECKER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-manuals-publisher-link-checker-api
            key: bearer_token
      - name: LINK_CHECKER_API_SECRET_TOKEN
        valueFrom:
          secretKeyRef:
            name: manuals-publisher-link-checker-api-callback-token
            key: LINK_CHECKER_API_SECRET_TOKEN
      - name: MONGODB_URI
        valueFrom:
          secretKeyRef:
            name: manuals-publisher-docdb
            key: MONGODB_URI
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: maslow
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "maslow.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: maslow.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-maslow
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-maslow
            key: oauth_secret
      - name: MEMCACHE_SERVERS
        value: frontend-memcached-govuk.eks.integration.govuk-internal.digital
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-maslow-publishing-api
            key: bearer_token
      - name: MONGODB_URI
        valueFrom:
          secretKeyRef:
            name: maslow-docdb
            key: MONGODB_URI

- name: publisher
  helmValues:
    dbMigrationEnabled: true
    workerEnabled: true
    cronTasks:
      - name: mail-fetcher
        command: "script/mail_fetcher"
        schedule: "*/5 * * * *"
      - name: reports-generate
        task: "reports:generate"
        schedule: "0 * * * *"
      - name: reschedule-pubs-after-db-restore  # non-prod only
        task: "editions:requeue_scheduled_for_publishing"
        schedule: "38 7 * * 1-5"
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "publisher.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: publisher.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-publisher
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-publisher
            key: oauth_secret
      - name: ASSET_MANAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-publisher-asset-manager
            key: bearer_token
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-publisher-publishing-api
            key: bearer_token
      - name: FACT_CHECK_USERNAME
        valueFrom:
          secretKeyRef:
            name: publisher-fact-check-email-account
            key: FACT_CHECK_USERNAME
      - name: FACT_CHECK_PASSWORD
        valueFrom:
          secretKeyRef:
            name: publisher-fact-check-email-account
            key: FACT_CHECK_PASSWORD
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: publisher-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: JWT_AUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: authenticating-proxy-jwt-auth-secret
            key: JWT_AUTH_SECRET
      - name: LINK_CHECKER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-publisher-link-checker-api
            key: bearer_token
      - name: LINK_CHECKER_API_SECRET_TOKEN
        valueFrom:
          secretKeyRef:
            name: publisher-link-checker-api-callback-token
            key: LINK_CHECKER_API_SECRET_TOKEN
      - name: MONGODB_URI
        valueFrom:
          secretKeyRef:
            name: publisher-docdb
            key: MONGODB_URI
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: EMAIL_GROUP_BUSINESS
        value: mainstream-publisher-notifications-integration@digital.cabinet-office.gov.uk
      - name: EMAIL_GROUP_CITIZEN
        value: mainstream-publisher-notifications-integration@digital.cabinet-office.gov.uk
      - name: EMAIL_GROUP_DEV
        value: mainstream-publisher-notifications-integration@digital.cabinet-office.gov.uk
      - name: EMAIL_GROUP_FORCE_PUBLISH_ALERTS
        value: mainstream-publisher-notifications-integration@digital.cabinet-office.gov.uk
      - name: FACT_CHECK_SUBJECT_PREFIX
        value: dev
      - name: FACT_CHECK_REPLY_TO_ADDRESS
        value: govuk-fact-check-integration@digital.cabinet-office.gov.uk
      - name: FACT_CHECK_REPLY_TO_ID
        value: 6b6ee566-54f2-48f6-98c4-21a373e6dea2
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: REPORTS_S3_BUCKET_NAME
        value: govuk-integration-publisher-csvs
      - name: AWS_REGION
        value: eu-west-1

- name: publishing-api
  helmValues:
    nginxClientMaxBodySize: 2M
    dbMigrationEnabled: true
    uploadAssets:
      enabled: false
    workerEnabled: true
    cronTasks:
      - name: events-export
        task: "events:export_to_s3"
        schedule: "38 5 * * 0"
      - name: heartbeat
        task: "heartbeat_messages:send"
        schedule: "*/4 * * * *"
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-publishing-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-publishing-api
            key: oauth_secret
      - name: CONTENT_STORE_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-publishing-api-content-store
            key: bearer_token
      - name: DRAFT_CONTENT_STORE_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-publishing-api-draft-content-store
            key: bearer_token
      - name: ROUTER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-publishing-api-router-api
            key: bearer_token
      - name: RABBITMQ_URL
        valueFrom:
          secretKeyRef:
            name: publishing-api-rabbitmq
            key: RABBITMQ_URL
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: EVENT_LOG_AWS_BUCKETNAME
        value: govuk-publishing-api-event-log-integration
      - name: GOVUK_CONTENT_SCHEMAS_PATH
        value: /app/content_schemas
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: publishing-api-postgres
            key: DATABASE_URL

- name: release
  helmValues:
    dbMigrationEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "release.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: release.{{ .Values.k8sExternalDomainSuffix }}
    workerEnabled: true
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-release
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-release
            key: oauth_secret
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: release-mysql
            key: DATABASE_URL
      - name: GITHUB_USERNAME
        valueFrom:
          secretKeyRef:
            name: release-github
            key: username
      - name: GITHUB_ACCESS_TOKEN
        valueFrom:
          secretKeyRef:
            name: release-github
            key: token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: SLACK_WEBHOOK_URL
        valueFrom:
          secretKeyRef:
            name: slack-webhook-url
            key: url

- name: router-api
  helmValues: &router-api
    dnsConfig:  # TODO: remove dnsConfig once MongoDB migrated to DocDB.
      searches:
        - blue.integration.govuk-internal.digital
    uploadAssets:
      enabled: false
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-router-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-router-api
            key: oauth_secret
      - name: MONGODB_URI  # Hostnames need to match those shown in MongoDB rs.status().
        value: "mongodb://\
          router-backend-1,\
          router-backend-2,\
          router-backend-3/router"

- name: draft-router-api
  repoName: router-api
  helmValues:
    <<: *router-api
    rails:
      createKeyBaseSecret: false
    sentry:
      createSecret: false  # Sentry DSNs are per repo.
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-draft-router-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-draft-router-api
            key: oauth_secret
      - name: MONGODB_URI  # Hostnames need to match those shown in MongoDB rs.status().
        value: "mongodb://\
          router-backend-1,\
          router-backend-2,\
          router-backend-3/draft_router"

- name: router
  helmValues:
    rails:
      enabled: false
    uploadAssets:
      enabled: false
    dnsConfig:  # TODO: remove dnsConfig once MongoDB migrated to DocDB.
      searches:
        - blue.integration.govuk-internal.digital
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-www-waf-ruleset
        alb.ingress.kubernetes.io/security-groups: eks_ingress_www_origin
        alb.ingress.kubernetes.io/load-balancer-name: www-origin
        alb.ingress.kubernetes.io/load-balancer-attributes: >
          access_logs.s3.enabled=true,
          access_logs.s3.bucket=govuk-{{ .Values.govukEnvironment }}-aws-logging,
          access_logs.s3.prefix=elb/www-origin
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "www.{{ .Values.externalDomainSuffix }}",
              "www-origin.{{ .Values.publishingDomainSuffix }}",
              "www.{{ .Values.k8sExternalDomainSuffix }}"
          ]}}]
      hosts:
        - name: www-origin.{{ .Values.k8sExternalDomainSuffix }}
    nginxConfigMap:
      create: false
      name: live-router-nginx-conf
    nginxExtraVolumeMounts:
      - name: live-router-nginx-conf
        mountPath: /usr/share/nginx/html/robots.txt
        subPath: robots.txt
      - name: router-nginx-htpasswd
        mountPath: /etc/nginx/htpasswd
    extraVolumes:
      - name: router-nginx-htpasswd
        secret:
          secretName: router-nginx-htpasswd
    appProbes: &router-app-probes
      startupProbe: &router-probe
        httpGet:
          path: /healthcheck
          port: 9394
        failureThreshold: 10
        periodSeconds: 1
        timeoutSeconds: 1
      livenessProbe:
        <<: *router-probe
        failureThreshold: 3
        periodSeconds: 5
      readinessProbe:
        <<: *router-probe
        httpGet:
          path: /healthcheck
          port: 9394
        failureThreshold: 2
        periodSeconds: 5
    extraEnv:
      - name: GOMAXPROCS
        value: "2"
      - name: SENTRY_ENVIRONMENT
        value: "integration"
      - name: ROUTER_PUBADDR
        value: ":3000"
      - name: ROUTER_APIADDR
        value: ":9394"
      - name: ROUTER_MONGO_URL
        value: &router_mongo_hosts "\
          router-backend-1,\
          router-backend-2,\
          router-backend-3"
      - name: BACKEND_URL_collections
        value: "http://collections"
      - name: BACKEND_URL_content-store
        value: "http://content-store"
      - name: BACKEND_URL_email-alert-frontend
        value: "http://email-alert-frontend"
      - name: BACKEND_URL_frontend
        value: "http://frontend"
      - name: BACKEND_URL_government-frontend
        value: "http://government-frontend"
      - name: BACKEND_URL_smartanswers
        value: "http://smartanswers"
      - name: BACKEND_URL_static
        value: "http://static"
      - name: BACKEND_URL_whitehall-frontend
        value: "http://whitehall-frontend"
      - name: BACKEND_URL_account-api
        value: "http://account-api"
      - name: BACKEND_URL_feedback
        value: "http://feedback"
      - name: BACKEND_URL_finder-frontend
        value: "http://finder-frontend"
      - name: BACKEND_URL_info-frontend
        value: "http://info-frontend"
      - name: BACKEND_URL_licencefinder
        value: "http://licencefinder"
      - name: BACKEND_URL_licensify
        value: "https://licensify.integration.govuk-internal.digital"
      - name: BACKEND_URL_search-api
        value: "http://search-api"
- name: draft-router
  repoName: router
  helmValues:
    rails:
      enabled: false
    sentry:
      createSecret: false  # Sentry DSNs are per repo.
    uploadAssets:
      enabled: false
    dnsConfig:  # TODO: remove dnsConfig once MongoDB migrated to DocDB.
      searches:
        - blue.integration.govuk-internal.digital
    appProbes: *router-app-probes
    nginxConfigMap:
      create: false
      name: draft-router-nginx-conf
    extraEnv:
      - name: GOMAXPROCS
        value: "2"
      - name: ROUTER_PUBADDR
        value: ":3000"
      - name: ROUTER_APIADDR
        value: ":9394"
      - name: ROUTER_MONGO_URL  # Hostnames should match those shown in MongoDB rs.status().
        value: *router_mongo_hosts
      - name: ROUTER_MONGO_DB
        value: draft_router
      - name: BACKEND_URL_collections
        value: "http://draft-collections"
      - name: BACKEND_URL_content-store
        value: "http://draft-content-store"
      - name: BACKEND_URL_email-alert-frontend
        value: "http://draft-email-alert-frontend"
      - name: BACKEND_URL_frontend
        value: "http://draft-frontend"
      - name: BACKEND_URL_government-frontend
        value: "http://draft-government-frontend"
      - name: BACKEND_URL_smartanswers
        value: "http://draft-smartanswers"
      - name: BACKEND_URL_static
        value: "http://draft-static"
      - name: BACKEND_URL_whitehall-frontend
        value: "http://whitehall-frontend"  # There is no draft version whitehall frontend
      - name: BACKEND_URL_account-api
        value: "http://account-api"
      - name: BACKEND_URL_feedback
        value: "http://feedback"
      - name: BACKEND_URL_finder-frontend
        value: "http://finder-frontend"
      - name: BACKEND_URL_info-frontend
        value: "http://info-frontend"
      - name: BACKEND_URL_licencefinder
        value: "http://licencefinder"
      - name: BACKEND_URL_licensify
        value: "https://licensify.integration.govuk-internal.digital"
      - name: BACKEND_URL_search-api
        value: "http://search-api"

- name: search-admin
  helmValues:
    dbMigrationEnabled: true
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "search-admin.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: search-admin.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-search-admin
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-search-admin
            key: oauth_secret
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-search-admin-publishing-api
            key: bearer_token
      - name: RUMMAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-search-admin-search-api
            key: bearer_token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: search-admin-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: search-admin-mysql
            key: DATABASE_URL

- name: search-api
  helmValues:
    rails:
      enabled: false
    nginxClientMaxBodySize: 20M
    uploadAssets:
      enabled: false
    workerEnabled: true
    workerReplicaCount: 3
    cronTasks:
      - name: reindex-with-new-schemas
        task: "search:migrate_schema"
        schedule: "5 21 * * 1"
      - name: generate-sitemap
        task: "sitemap:generate_and_upload"
        schedule: "50 2 * * *"
      - name: load-page-traffic
        command: "./bin/load_page_traffic.sh"
        schedule: "32 4 * * *"
        env:
        - name: AWS_SEARCH_ANALYTICS_BUCKET
          value: govuk-search-analytics-integration
      - name: update-detailed-index-popularity
        task: "search:update_popularity"
        schedule: "42 4 * * *"
        env:
        - name: SEARCH_INDEX
          value: detailed
        - name: PROCESS_ALL_DATA
          value: "true"
      - name: update-government-index-popularity
        task: "search:update_popularity"
        schedule: "12 5 * * *"
        env:
        - name: SEARCH_INDEX
          value: government
        - name: PROCESS_ALL_DATA
          value: "true"
      - name: update-govuk-index-popularity
        task: "search:update_popularity"
        schedule: "42 5 * * *"
        env:
        - name: SEARCH_INDEX
          value: govuk
    workers:
      - command: ["sidekiq", "-C", "config/sidekiq.yml"]
        name: worker
      - command: ['rake', 'message_queue:listen_to_publishing_queue']
        name: publishing-queue-listener
      - command: ['rake', 'message_queue:insert_data_into_govuk']
        name: govuk-index-queue-listener
      - command: ['rake', 'message_queue:bulk_insert_data_into_govuk']
        name: bulk-reindex-queue-listener
    extraEnv:
      - name: AWS_REGION
        value: eu-west-1
      - name: AWS_S3_RELEVANCY_BUCKET_NAME
        value: govuk-integration-search-relevancy
      - name: AWS_S3_SITEMAPS_BUCKET_NAME
        value: govuk-integration-sitemaps
      - name: ELASTICSEARCH_URI
        value: *elasticsearch-uri
      - name: ENABLE_LTR
        value: "true"
      - name: SEARCH_INDEX
        value: all
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-search-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-search-api
            key: oauth_secret
      - name: GOOGLE_ANALYTICS_GOVUK_VIEW_ID
        valueFrom:
          secretKeyRef:
            name: search-api-google-analytics
            key: govuk-view-id
      - name: GOOGLE_CLIENT_EMAIL
        valueFrom:
          secretKeyRef:
            name: search-api-google-analytics
            key: client-email
      - name: GOOGLE_EXPORT_ACCOUNT_ID
        valueFrom:
          secretKeyRef:
            name: search-api-google-analytics
            key: export-account-id
      - name: GOOGLE_EXPORT_CUSTOM_DATA_SOURCE_ID
        valueFrom:
          secretKeyRef:
            name: search-api-google-analytics
            key: export-custom-data-source-id
      - name: GOOGLE_EXPORT_WEB_PROPERTY_ID
        valueFrom:
          secretKeyRef:
            name: search-api-google-analytics
            key: export-web-property-id
      - name: GOOGLE_PRIVATE_KEY
        valueFrom:
          secretKeyRef:
            name: search-api-google-analytics
            key: private-key
      - name: GOOGLE_BIGQUERY_CREDENTIALS
        valueFrom:
          secretKeyRef:
            name: search-api-google-bigquery
            key: credentials
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-search-api-publishing-api
            key: bearer_token
      - name: RABBITMQ_URL
        valueFrom:
          secretKeyRef:
            name: search-api-rabbitmq
            key: RABBITMQ_URL
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: TENSORFLOW_SAGEMAKER_ENDPOINT
        value: govuk-integration-search-ltr-endpoint

- name: service-manual-publisher
  helmValues:
    dbMigrationEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "service-manual-publisher.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: service-manual-publisher.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-service-manual-publisher
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-service-manual-publisher
            key: oauth_secret
      - name: ASSET_MANAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-service-manual-publisher-asset-manager
            key: bearer_token
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-service-manual-publisher-publishing-api
            key: bearer_token
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: service-manual-publisher-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: service-manual-publisher-postgres
            key: DATABASE_URL
      - name: HTTP_USERNAME
        valueFrom:
          secretKeyRef:
            name: basic-auth
            key: username
      - name: HTTP_PASSWORD
        valueFrom:
          secretKeyRef:
            name: basic-auth
            key: password

- name: signon
  helmValues:
    dbMigrationEnabled: true
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        # TODO: remove certificate-arn annotation once ambiguous certs are removed from Cert Manager.
        alb.ingress.kubernetes.io/certificate-arn: arn:aws:acm:eu-west-1:210287912431:certificate/4ed0629c-1960-4696-80a4-895bda3ea5d5
        external-dns.alpha.kubernetes.io/hostname: signon.{{ .Values.k8sExternalDomainSuffix }}
      hosts:
        - name: signon.{{ .Values.publishingDomainSuffix }}
    cronTasks:
      - name: delete-expired-oauth-grants
        task: "oauth_access_grants:delete_expired"
        schedule: "29 12 * * 0"
        serviceAccount: signon
      - name: delete-logs-older-than-two-years
        task: "event_log:delete_logs_older_than_two_years"
        schedule: "16 1 * * *"
        serviceAccount: signon
      - name: fetch-whitehall-organisations
        task: "organisations:fetch"
        schedule: "11 11 * * *"
        serviceAccount: signon
      - name: send-suspension-reminders
        task: "users:send_suspension_reminders"
        schedule: "57 11 * * *"
        serviceAccount: signon
      - name: suspend-inactive-users
        task: "users:suspend_inactive"
        schedule: "27 11 * * *"
        serviceAccount: signon
      - name: sync-app-secrets-to-k8s
        task: "kubernetes:sync_app_secrets[signon-secrets-sync-conf]"
        schedule: "6 1 * * *"
        serviceAccount: signon
      - name: sync-token-secrets-to-k8s
        task: "kubernetes:sync_token_secrets[signon-secrets-sync-conf]"
        schedule: "7 1 * * *"
        serviceAccount: signon
    extraEnv:
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: signon-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: INSTANCE_NAME
        value: integration
      - name: ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY
        valueFrom:
          secretKeyRef:
            name: active-record-encryption
            key: ACTIVE_RECORD_ENCRYPTION_PRIMARY_KEY
      - name: ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT
        valueFrom:
          secretKeyRef:
            name: active-record-encryption
            key: ACTIVE_RECORD_ENCRYPTION_KEY_DERIVATION_SALT
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: signon-mysql
            key: DATABASE_URL
      - name: DEVISE_PEPPER
        valueFrom:
          secretKeyRef:
            name: signon-devise-pepper
            key: DEVISE_PEPPER
      - name: DEVISE_SECRET_KEY
        valueFrom:
          secretKeyRef:
            name: signon-devise-secret
            key: DEVISE_SECRET_KEY
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: SSO_PUSH_USER_EMAIL
        value: signon+permissions@alphagov.co.uk
      - name: SIGNON_ADMIN_PASSWORD
        valueFrom:
          secretKeyRef:
            name: signon-auth-token
            key: token

- name: smartanswers
  repoName: smart-answers
  helmValues:
    uploadAssets:
      # https://github.com/alphagov/smart-answers/blob/9b65057/config/application.rb#L50
      path: /app/public/assets/smartanswers
      s3Directory: "smartanswers"
    extraEnv:
      - name: EXPOSE_GOVSPEAK
        value: "1"
      - name: LINK_CHECKER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-smart-answers-link-checker-api
            key: bearer_token
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-smart-answers-publishing-api
            key: bearer_token
      - name: ZENDESK_CLIENT_USERNAME
        valueFrom:
          secretKeyRef:
            name: smartanswers-zendesk-client
            key: username
      - name: ZENDESK_CLIENT_PASSWORD
        valueFrom:
          secretKeyRef:
            name: smartanswers-zendesk-client
            key: password

- name: smokey
  chartPath: charts/smokey
  helmValues:
    cronSchedule: "*/10 7-19 * * 1-5"

- name: static
  helmValues:
    uploadStaticErrorPagesEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-www-waf-ruleset
        alb.ingress.kubernetes.io/load-balancer-name: assets-origin
        alb.ingress.kubernetes.io/group.name: assets-origin
        alb.ingress.kubernetes.io/group.order: '30'
        alb.ingress.kubernetes.io/security-groups: eks_ingress_www_origin
        alb.ingress.kubernetes.io/load-balancer-attributes: *assets-lb-attributes
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: *assets-lb-conditions
      hosts:
        - name: assets-origin.{{ .Values.k8sExternalDomainSuffix }}
          path: /
    extraEnv:
      # These GA/GTM values are not secrets (not even the the gtm_auth one).
      # https://github.com/alphagov/govuk-puppet/pull/8041
      - name: RAILS_SERVE_STATIC_FILES
        value: "true"
      - name: GA_UNIVERSAL_ID
        value: &ga-universal-id UA-26179049-22
      - name: GOOGLE_TAG_MANAGER_ID
        value: &static-gtm-id GTM-MG7HG5W
      - name: GOOGLE_TAG_MANAGER_AUTH  # Non-prod only.
        value: &static-gtm-auth C7iYdcsOlYgGmiUJjZKrHQ
      - name: GOOGLE_TAG_MANAGER_PREVIEW  # Non-prod only.
        value: &static-gtm-preview env-4
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-static-publishing-api
            key: bearer_token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: USE_TMPDIR_PAGE_CACHE
        value: "true"
    nginxConfigMap:
      extraServerConf: |
        # 1stline use this URL in their zendesk template
        location = /static/gov.uk_logotype_crown.png {
          absolute_redirect off;
          return 301 /media/5c810ef4ed915d43e50ce260/gov.uk_logotype_crown.png;
        }
        # Google site verification
        location = /googlec908b3bc32386239.html {
          return 200 'google-site-verification: googlec908b3bc32386239.html';
        }

- name: draft-static
  repoName: static
  helmValues:
    rails:
      createKeyBaseSecret: false
    sentry:
      createSecret: false
    uploadAssets:
      enabled: false
    extraEnv:
      - name: DRAFT_ENVIRONMENT
        value: "1"
      - name: PLEK_HOSTNAME_PREFIX
        value: draft-
      - name: GA_UNIVERSAL_ID
        value: *ga-universal-id
      - name: GOOGLE_TAG_MANAGER_ID
        value: *static-gtm-id
      - name: GOOGLE_TAG_MANAGER_AUTH  # Non-prod only.
        value: *static-gtm-auth
      - name: GOOGLE_TAG_MANAGER_PREVIEW  # Non-prod only.
        value: *static-gtm-preview
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-static-publishing-api
            key: bearer_token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: USE_TMPDIR_PAGE_CACHE
        value: "true"

- name: short-url-manager
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "short-url-manager.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: short-url-manager.{{ .Values.k8sExternalDomainSuffix }}
    cronTasks:
      - name: organisations-import
        task: "organisations:import"
        schedule: "0 4 * * *"
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-short-url-manager
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-short-url-manager
            key: oauth_secret
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: short-url-manager-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: INSTANCE_NAME
        value: integration
      - name: MONGODB_URI
        valueFrom:
          secretKeyRef:
            name: short-url-manager-docdb
            key: MONGODB_URI
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-short-url-manager-publishing-api
            key: bearer_token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: specialist-publisher
  helmValues:
    nginxClientMaxBodySize: *max-upload-size
    nginxProxyReadTimeout: 30s
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "specialist-publisher.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: specialist-publisher.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: ASSET_MANAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-specialist-publisher-asset-manager
            key: bearer_token
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-specialist-publisher-email-alert-api
            key: bearer_token
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-specialist-publisher-publishing-api
            key: bearer_token
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-specialist-publisher
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-specialist-publisher
            key: oauth_secret
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: specialist-publisher-aws
            key: access_key
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: specialist-publisher-aws
            key: secret_key
      - name: AWS_REGION
        value: eu-west-1
      - name: AWS_S3_BUCKET_NAME
        value: govuk-integration-specialist-publisher-csvs
      - name: MONGODB_URI
        valueFrom:
          secretKeyRef:
            name: specialist-publisher-docdb
            key: MONGODB_URI
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: support-api-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: PUBLISH_PRE_PRODUCTION_FINDERS
        value: "yes"

- name: support
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "support.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: support.{{ .Values.k8sExternalDomainSuffix }}
    uploadAssets:
      path: /app/public/assets/support
    workerEnabled: true
    extraEnv:
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: support-aws
            key: access_key
      - name: AWS_REGION
        value: eu-west-1
      - name: AWS_S3_BUCKET_NAME
        value: govuk-integration-support-api-csvs
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: support-aws
            key: secret_key
      - name: EMERGENCY_CONTACT_DETAILS
        valueFrom:
          secretKeyRef:
            name: support-emergency-contacts
            key: emergency_contacts
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-support
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-support
            key: oauth_secret
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-support-publishing-api
            key: bearer_token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: SUPPORT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-support-support-api
            key: bearer_token
      - name: ZENDESK_CLIENT_USERNAME
        valueFrom:
          secretKeyRef:
            name: support-zendesk
            key: username
      - name: ZENDESK_CLIENT_PASSWORD
        valueFrom:
          secretKeyRef:
            name: support-zendesk
            key: password
      - name: ZENDESK_ANONYMOUS_TICKET_EMAIL
        valueFrom:
          secretKeyRef:
            name: support-zendesk
            key: ticket_email

- name: support-api
  helmValues:
    dbMigrationEnabled: true
    uploadAssets:
      enabled: false
    workerEnabled: true
    cronTasks:
      - name: feedback-deduplication-nightly
        task: "anonymous_feedback_deduplication:nightly"
        schedule: "10 0 * * *"
      - name: import-organisations
        task: "api_sync:import_organisations"
        schedule: "20 0 * * *"
      - name: service-feedback-aggregation
        task: "service_feedback_aggregation:daily"
        schedule: "30 0 * * *"
      - name: feedback-deduplication-recent
        task: "anonymous_feedback_deduplication:recent"
        schedule: "*/5 * * * *"
    extraEnv:
      - name: AWS_ACCESS_KEY_ID
        valueFrom:
          secretKeyRef:
            name: support-aws
            key: access_key
      - name: AWS_REGION
        value: eu-west-1
      - name: AWS_S3_BUCKET_NAME
        value: govuk-integration-support-api-csvs
      - name: AWS_SECRET_ACCESS_KEY
        valueFrom:
          secretKeyRef:
            name: support-aws
            key: secret_key
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: support-api-postgres
            key: DATABASE_URL
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-support-api
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-support-api
            key: oauth_secret
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: support-api-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: ZENDESK_CLIENT_USERNAME
        valueFrom:
          secretKeyRef:
            name: support-zendesk
            key: username
      - name: ZENDESK_CLIENT_PASSWORD
        valueFrom:
          secretKeyRef:
            name: support-zendesk
            key: password
      - name: ZENDESK_ANONYMOUS_TICKET_EMAIL
        valueFrom:
          secretKeyRef:
            name: support-zendesk
            key: ticket_email

- name: transition
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "transition.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: transition.{{ .Values.k8sExternalDomainSuffix }}
    dbMigrationEnabled: true
    workerEnabled: true
    transitionConfigEnabled: true
    cronTasks:
      - name: import-dns
        task: "import:dns_details"
        schedule: "3 07-19 * * 1-5"
      - name: import-hits-from-cdn-logs
        task: "import:all:hits[govuk-integration-transition-fastly-logs]"
        schedule: "22 3 * * *"
      - name: clear-expired-sessions
        task: "clear_expired_sessions"
        schedule: "58 3 * * *"
      - name: clear-old-mappings
        task: "clear_old_mappings_batches"
        schedule: "52 3 * * *"
      - name: refresh-materialized-hits
        task: "import:hits:refresh_materialized"
        schedule: "38 0,12 * * *"
    extraVolumes:
      - name: transition-config-efs
        nfs:
          server: *assets-nfs
          path: /transition
    appExtraVolumeMounts:
      - name: transition-config-efs
        mountPath: /app/data
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-transition
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-transition
            key: oauth_secret
      - name: AWS_REGION
        value: eu-west-1
      - name: BASIC_AUTH_PASSWORD
        valueFrom:
          secretKeyRef:
            name: basic-auth
            key: password
      - name: BASIC_AUTH_USERNAME
        valueFrom:
          secretKeyRef:
            name: basic-auth
            key: username
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: transition-postgres
            key: DATABASE_URL
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: travel-advice-publisher
  helmValues:
    nginxClientMaxBodySize: *max-upload-size
    workerEnabled: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "travel-advice-publisher.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: travel-advice-publisher.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: ASSET_MANAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-travel-advice-publisher-asset-manager
            key: bearer_token
      - name: EMAIL_ALERT_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-travel-advice-publisher-email-alert-api
            key: bearer_token
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-travel-advice-publisher
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-travel-advice-publisher
            key: oauth_secret
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-travel-advice-publisher-publishing-api
            key: bearer_token
      - name: LINK_CHECKER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-travel-advice-publisher-link-checker-api
            key: bearer_token
      - name: LINK_CHECKER_API_SECRET_TOKEN
        valueFrom:
          secretKeyRef:
            name: travel-advice-publisher-link-checker-api-callback-token
            key: LINK_CHECKER_API_SECRET_TOKEN
      - name: MONGODB_URI
        valueFrom:
          secretKeyRef:
            name: travel-advice-publisher-docdb
            key: MONGODB_URI
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital

- name: govuk-replatform-test-app
  helmValues:
    rails:
      enabled: false
    sentry:
      enabled: false
    uploadAssets:
      enabled: false
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
      hosts:
        - name: govuk-replatform-test-app.eks.integration.govuk.digital
    extraEnv:
      - name: ENV_MESSAGE_EXAMPLE
        value: message_by_example
      - name: ENV_MESSAGE_MAISY
        value: message_by_maisy
      - name: ENV_MESSAGE_OTHER
        value: message_by_other
      - name: ENV_MESSAGE_ROSA
        value: hi

- name: whitehall-admin
  repoName: whitehall
  helmValues:
    securityContext:
      # Use the same uid/gid for NFS permissions as the old stack, so that
      # files uploaded by whitehall-admin on k8s can be processed by
      # whitehall-admin on EC2 and vice versa. 2899 is the "deploy" user.
      runAsUser: 2899
      runAsGroup: 2899
    cronTasks:
      - name: index-consultations
        task: "search:index:consultations"
        schedule: "0 2-22 * * *"
      - name: send-notifications
        task: "publisher_notifications:send"
        schedule: "18 1 * * *"
      - name: taxonomy-rebuild
        task: "taxonomy:rebuild_cache"
        schedule: "*/10 7-20 * * *"
    dbMigrationEnabled: true
    workerEnabled: true
    nginxClientMaxBodySize: *max-upload-size
    nginxDenyCrawlers: true
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-backend-waf-ruleset
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: >
          [{"field": "host-header", "hostHeaderConfig": { "values": [
              "whitehall-admin.{{ .Values.publishingDomainSuffix }}"
          ]}}]
      hosts:
        - name: whitehall-admin.{{ .Values.k8sExternalDomainSuffix }}
    extraEnv:
      - name: GDS_SSO_OAUTH_ID
        valueFrom:
          secretKeyRef:
            name: signon-app-whitehall
            key: oauth_id
      - name: GDS_SSO_OAUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: signon-app-whitehall
            key: oauth_secret
      - name: GOVUK_UPLOADS_ROOT
        value: &whitehall-uploads-path /uploads
      - name: ASSET_MANAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-whitehall-asset-manager
            key: bearer_token
      - name: GOVUK_NOTIFY_API_KEY
        valueFrom:
          secretKeyRef:
            name: whitehall-notify
            key: GOVUK_NOTIFY_API_KEY
      - name: JWT_AUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: authenticating-proxy-jwt-auth-secret
            key: JWT_AUTH_SECRET
      - name: LINK_CHECKER_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-whitehall-link-checker-api
            key: bearer_token
      - name: LINK_CHECKER_API_SECRET_TOKEN
        valueFrom:
          secretKeyRef:
            name: whitehall-link-checker-api-callback-token
            key: LINK_CHECKER_API_SECRET_TOKEN
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-whitehall-publishing-api
            key: bearer_token
      - name: RUMMAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-whitehall-search-api
            key: bearer_token
      - name: AWS_REGION
        value: eu-west-1
      - name: AWS_S3_BUCKET_NAME
        value: govuk-integration-whitehall-csvs
      - name: GOVUK_NOTIFY_TEMPLATE_ID
        value: *publishing-notify-template
      - name: EMAIL_ADDRESS_OVERRIDE
        value: whitehall-emails-integration@digital.cabinet-office.gov.uk
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: whitehall-admin-mysql
            key: DATABASE_URL
    extraVolumes:
      - name: asset-uploads-efs
        nfs:
          server: *assets-nfs
          path: /whitehall  # TODO: does this work on an new/empty EFS instance?
    appExtraVolumeMounts:
      - name: asset-uploads-efs
        mountPath: *whitehall-uploads-path
- name: whitehall-frontend
  repoName: whitehall
  helmValues:
    ingress:
      enabled: true
      annotations:
        <<: *default-alb-ingress-annotations
        <<: *alb-ingress-www-waf-ruleset
        alb.ingress.kubernetes.io/load-balancer-name: assets-origin
        alb.ingress.kubernetes.io/group.name: assets-origin
        alb.ingress.kubernetes.io/group.order: '10'
        alb.ingress.kubernetes.io/security-groups: eks_ingress_www_origin
        alb.ingress.kubernetes.io/load-balancer-attributes: *assets-lb-attributes
        alb.ingress.kubernetes.io/conditions.{{ .Release.Name }}: *assets-lb-conditions
      hosts:
        - name: assets-origin.{{ .Values.k8sExternalDomainSuffix }}
          path: /government/placeholder/
        - name: assets-origin.{{ .Values.k8sExternalDomainSuffix }}
          path: /assets/whitehall/
        - name: assets-origin.{{ .Values.k8sExternalDomainSuffix }}
          path: /government/uploads/system/uploads/attachment_data/file/*/*/preview
          pathType: ImplementationSpecific
    rails:
      createKeyBaseSecret: false
    sentry:
      createSecret: false  # Sentry DSNs are per repo.
    extraEnv:
      - name: JWT_AUTH_SECRET
        valueFrom:
          secretKeyRef:
            name: authenticating-proxy-jwt-auth-secret
            key: JWT_AUTH_SECRET
      - name: PUBLISHING_API_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-whitehall-publishing-api
            key: bearer_token
      - name: RUMMAGER_BEARER_TOKEN
        valueFrom:
          secretKeyRef:
            name: signon-token-whitehall-search-api
            key: bearer_token
      - name: REDIS_URL
        value: redis://shared-redis-govuk.eks.integration.govuk-internal.digital
      - name: MEMCACHE_SERVERS
        value: frontend-memcached-govuk.eks.integration.govuk-internal.digital
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: whitehall-frontend-mysql
            key: DATABASE_URL
    appResources:
      limits:
        cpu: 1
        memory: 2Gi
      requests:
        cpu: 0.1
        memory: 1Gi

rule_files:
  - mirrors.yaml

evaluation_interval: 1m

tests:
  - interval: 1m
    input_series:
      - series: 'govuk_mirror_last_updated_time{backend="backend1"}'
        values: '1622478600'

    promql_expr_test:
      - expr: |
          time() - min(govuk_mirror_last_updated_time) by (backend)
        eval_time: 1622500200s
        exp_samples:
          - labels: 'global:govuk_mirror_freshness_seconds{backend="backend1"}'
            value: 21600

  - interval: 1m
    input_series:
      - series: 'govuk_mirror_last_updated_time{backend="backend1"}'
        values: '1622478600'

    alert_rule_test:
      - eval_time: 1622694600s  # 48 hours and 30 minutes later
        alertname: MirrorFreshnessAlert
        exp_alerts:
          - exp_labels:
              backend: backend1
            exp_annotations:
              summary: Mirror freshness has exceeded two days
              description: The mirror hasn't been updated in more than two days

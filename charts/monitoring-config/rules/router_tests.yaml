rule_files:
  - router.yaml

evaluation_interval: 1m

tests:
  # Alert fires when threshold exceeded for too long.
  - interval: 1m
    input_series:
      - series: 'router_backend_handler_response_duration_seconds_count{response_code="500", namespace="apps", job="router"}'
        values: '0 2+1x6 8x4'
      - series: 'router_backend_handler_response_duration_seconds_count{namespace="apps", job="router"}'
        values: '0+1x11'
    alert_rule_test:
      - eval_time: 11m
        alertname: RouterBackendHandlerResponse5xxErrorRate
        exp_alerts:
          - exp_labels:
              severity: page
              job: router
            exp_annotations:
              summary: High 5xx error rate for router
              description: router has high 5xx error rate for more than 10 minutes.

  # Alert does not fire when threshold not exceeded for long enough.
  - interval: 1m
    input_series:
      - series: 'router_backend_handler_response_duration_seconds_count{namespace="apps", job="router"}'
        values: '0+1x11'
      - series: 'router_backend_handler_response_duration_seconds_count{response_code="500", namespace="apps", job="router"}'
        # No alert triggered as only increase in router errors for 4 minutes
        values: '0 2+1x4 6x6'
    alert_rule_test:
      - eval_time: 11m
        alertname: RouterBackendHandlerResponse5xxErrorRate
        exp_alerts: []

rule_files:
  - search_api_v2.yaml

evaluation_interval: 1m

tests:
  - interval: 1m
    input_series:
      # Should alert (significant drop below threshold)
      - series: >-
          search_api_v2_quality_monitoring_score{dataset_name="dataset1", dataset_type="invariants"}
        values: '1 1 1 1 1 1 1 1 1 0.8'
      # Should alert (gradual decline over 6 hours)
      - series: >-
          search_api_v2_quality_monitoring_score{dataset_name="dataset2", dataset_type="invariants"}
        values: '1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 0.98 0.98 0.98 0.97 0.97 0.97 0.96 0.96 0.96 0.95 0.95 0.95 0.94 0.94 0.94 0.93 0.93 0.93 0.92 0.92 0.92 0.91 0.91 0.91'
      # Should not alert (stable or increasing)
      - series: >-
          search_api_v2_quality_monitoring_score{dataset_name="dataset3", dataset_type="invariants"}
        values: '1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1 1'
    alert_rule_test:
      - eval_time: 40m
        alertname: LowInvariantScore
        exp_alerts:
          - exp_labels:
              alertname: LowInvariantScore
              dataset_name: "dataset1"
              dataset_type: "invariants"
              severity: "critical"
              destination: "slack-search-team"
            exp_annotations:
              summary: "Low invariant recall score for 'dataset1'"
              description: >-
                Invariant dataset 'dataset1' has dropped below the critical threshold (0.9).
      - eval_time: 40m
        alertname: GradualDeclineInvariantScore
        exp_alerts:
          - exp_labels:
              alertname: GradualDeclineInvariantScore
              dataset_name: "dataset2"
              dataset_type: "invariants"
              severity: "warning"
              destination: "slack-search-team"
            exp_annotations:
              summary: "Gradual decline in invariant recall score for 'dataset2'"
              description: >-
                Invariant dataset 'dataset2' has shown a decline of more than 2% in recall score over the past 6 hours.

  - interval: 1m
    input_series:
      # brief but inconsistent blips
      - series: >-
          http_requests_total{
          namespace="apps", job="search-api-v2", controller="searches", action="show", status="200"
          }
        values: '1000 1000 1000 900 1000 1000 1000 900 1000 1000 1000 1000 1000 0 1000'
      - series: >-
          http_requests_total{
          namespace="apps", job="search-api-v2", controller="searches", action="show", status="500"
          }
        values: '0 0 0 100 0 0 0 100 0 0 0 0 0 1000 0'
    alert_rule_test:
      - alertname: HighQueryFailureRate
        eval_time: 15m
        exp_alerts: []
